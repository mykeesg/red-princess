let e=!1,t=!0;const o=["NORTH","NORTH_EAST","SOUTH_EAST","SOUTH","SOUTH_WEST","NORTH_WEST"],s={steps:"ðŸ‘£",keys:"ðŸ”‘",lock:"ðŸ”’",gems:"ðŸ’Ž"},r={spiral:"ðŸŒ€",diamond:"ðŸ”¶",loop:"âž°",bright:"ðŸ”†",circle:"ðŸ”´",square:"ðŸŸ©"},i={target:"ðŸŽ¯",star:"âœ´ï¸",slash:"ã€°ï¸",paint:"ðŸŽ¨",egg:"ðŸ¥š",grid:"ðŸ”³"},a=(e,t,o)=>o.x<=e&&o.y<=t&&e<=o.x+o.width&&t<=o.y+o.height,n=e=>`[${e.row};${e.col}]`,l=(e,t)=>e.row===t.row&&e.col===t.col,d=(e,t)=>o.find(o=>l(b(e,o),t));const h=new class{#e;constructor(e=0){this.setSeed(e)}setSeed(e){this.#e=e??Math.floor(Math.random()*Math.pow(2,31))+1}float(){return this.#e^=this.#e<<13,this.#e^=this.#e>>17,this.#e^=this.#e<<5,(this.#e>>>0)/4294967295}int32(){return this.#e^=this.#e<<13,this.#e^=this.#e>>17,this.#e^=this.#e<<5,0|this.#e}get seed(){return this.#e}}(Date.now()),c=()=>h.float(),u=(e=0)=>{return e?(t=0,o=e,Math.floor(c()*(o-t))+t):h.int32();var t,o},p=e=>e[u(e.length)],y={extraSteps:{invoke:()=>A.addResource("steps",2),description:"Take a rest.",triggerText:"You have gained 2 extra steps.",triggerLimit:-1,rarity:.5},extraKey:{invoke:()=>A.addResource("keys"),description:"Alohomora.",triggerText:"You have found a key.",triggerLimit:1,rarity:.3},money:{invoke:()=>A.addResource("gems"),description:"What's that spark in the corner?",triggerText:"You have found a gem.",triggerLimit:1,rarity:.3},taxes:{invoke:()=>A.removeResource("gems"),description:"Takes a toll on you.",triggerText:`You have to pay taxes: ${s.gems}`,triggerLimit:-1,rarity:.3},garden:{invoke:()=>A.setResource("steps",41),description:"Like starting again.",triggerText:"Your steps have been reset.",triggerLimit:-1,rarity:.4},shop:{invoke:()=>{A.getResource("gems")>=5&&(A.addResource("keys"),A.removeResource("gems",5))},description:"Buy your passage.",triggerText:"You can buy a key for #5 with [Space].",triggerLimit:1,rarity:.9},exit:{invoke:()=>{A.pause()},description:"",triggerText:"You have won!",triggerLimit:-1,rarity:0},noop:{invoke:()=>{},description:"A simple room.",triggerText:"",triggerLimit:-1,rarity:.7}};class f{constructor({from:e,to:t,duration:o,ease:s=e=>e,onUpdate:r,onComplete:i,loop:a=!1,reverse:n=!1,type:l=""}){this.from=e,this.to=t,this.duration=o,this.ease=s,this.onUpdate=r,this.onComplete=i,this.loop=a,this.reverse=n,this.active=!0,this.startTime=performance.now(),this.type=l}update(e){const t=Math.min((e-this.startTime)/this.duration,1),o=this.ease(t),s=this.from+(this.to-this.from)*o;this.onUpdate(s),1===t&&(this.loop?(this.reverse&&([this.from,this.to]=[this.to,this.from]),this.startTime=e):(this.active=!1,this.onComplete?.()))}}let g=[new f({from:.1,to:1,duration:800,loop:!0,reverse:!0,onUpdate:e=>V=e,type:"selection-pulse"}),new f({from:0,to:2*Math.PI,duration:2e3,loop:!0,onUpdate:e=>z=e,type:"refresh-rotate"})];class m{events;hallways;revealed;triggerCount;needsKey;items;coord;constructor(e=void 0){e?(this.events=e.events,this.hallways=e.hallways,this.revealed=e.revealed,this.triggerCount=e.triggerCount,this.needsKey=e.needsKey,this.items=e.items,this.coord=e.coord):this.#t()}#t(){this.events={enter:"noop",exit:"noop",use:"noop"},this.hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"unknown",enabled:!0},SOUTH_EAST:{status:"unknown",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"unknown",enabled:!0},NORTH_WEST:{status:"unknown",enabled:!0}},this.revealed=!1,this.triggerCount=0,this.needsKey=!1,this.items=[],this.coord={row:-1,col:-1}}#o(e){-1===y[e].triggerLimit?(y[e].invoke(),A.lastEffect=y[e].triggerText):this.triggerCount<y[e].triggerLimit?(y[e].invoke(),A.lastEffect=y[e].triggerText,this.triggerCount+=1):A.lastEffect=""}enter(){this.#o(this.events.enter)}use(){this.#o(this.events.use)}exit(){this.#o(this.events.exit)}copy(){return new m(JSON.parse(JSON.stringify(this)))}}const w=document.querySelector("#canvas"),S=w.getContext("2d"),F={AliceBlue:"#F0F8FF",AntiqueWhite:"#FAEBD7",Aqua:"#00FFFF",Aquamarine:"#7FFFD4",Azure:"#F0FFFF",Beige:"#F5F5DC",Bisque:"#FFE4C4",Black:"#000000",BlanchedAlmond:"#FFEBCD",Blue:"#0000FF",BlueViolet:"#8A2BE2",Brown:"#A52A2A",BurlyWood:"#DEB887",CadetBlue:"#5F9EA0",Chartreuse:"#7FFF00",Chocolate:"#D2691E",Coral:"#FF7F50",CornflowerBlue:"#6495ED",Cornsilk:"#FFF8DC",Crimson:"#DC143C",Cyan:"#00FFFF",DarkBlue:"#00008B",DarkCyan:"#008B8B",DarkGoldenRod:"#B8860B",DarkGray:"#A9A9A9",DarkGrey:"#A9A9A9",DarkGreen:"#006400",DarkKhaki:"#BDB76B",DarkMagenta:"#8B008B",DarkOliveGreen:"#556B2F",DarkOrange:"#FF8C00",DarkOrchid:"#9932CC",DarkRed:"#8B0000",DarkSalmon:"#E9967A",DarkSeaGreen:"#8FBC8F",DarkSlateBlue:"#483D8B",DarkSlateGray:"#2F4F4F",DarkSlateGrey:"#2F4F4F",DarkTurquoise:"#00CED1",DarkViolet:"#9400D3",DeepPink:"#FF1493",DeepSkyBlue:"#00BFFF",DimGray:"#696969",DimGrey:"#696969",DodgerBlue:"#1E90FF",FireBrick:"#B22222",FloralWhite:"#FFFAF0",ForestGreen:"#228B22",Fuchsia:"#FF00FF",Gainsboro:"#DCDCDC",GhostWhite:"#F8F8FF",Gold:"#FFD700",GoldenRod:"#DAA520",Gray:"#808080",Grey:"#808080",Green:"#008000",GreenYellow:"#ADFF2F",HoneyDew:"#F0FFF0",HotPink:"#FF69B4",IndianRed:"#CD5C5C",Indigo:"#4B0082",Ivory:"#FFFFF0",Khaki:"#F0E68C",Lavender:"#E6E6FA",LavenderBlush:"#FFF0F5",LawnGreen:"#7CFC00",LemonChiffon:"#FFFACD",LightBlue:"#ADD8E6",LightCoral:"#F08080",LightCyan:"#E0FFFF",LightGoldenRodYellow:"#FAFAD2",LightGray:"#D3D3D3",LightGrey:"#D3D3D3",LightGreen:"#90EE90",LightPink:"#FFB6C1",LightSalmon:"#FFA07A",LightSeaGreen:"#20B2AA",LightSkyBlue:"#87CEFA",LightSlateGray:"#778899",LightSlateGrey:"#778899",LightSteelBlue:"#B0C4DE",LightYellow:"#FFFFE0",Lime:"#00FF00",LimeGreen:"#32CD32",Linen:"#FAF0E6",Magenta:"#FF00FF",Maroon:"#800000",MediumAquaMarine:"#66CDAA",MediumBlue:"#0000CD",MediumOrchid:"#BA55D3",MediumPurple:"#9370DB",MediumSeaGreen:"#3CB371",MediumSlateBlue:"#7B68EE",MediumSpringGreen:"#00FA9A",MediumTurquoise:"#48D1CC",MediumVioletRed:"#C71585",MidnightBlue:"#191970",MintCream:"#F5FFFA",MistyRose:"#FFE4E1",Moccasin:"#FFE4B5",NavajoWhite:"#FFDEAD",Navy:"#000080",OldLace:"#FDF5E6",Olive:"#808000",OliveDrab:"#6B8E23",Orange:"#FFA500",OrangeRed:"#FF4500",Orchid:"#DA70D6",PaleGoldenRod:"#EEE8AA",PaleGreen:"#98FB98",PaleTurquoise:"#AFEEEE",PaleVioletRed:"#DB7093",PapayaWhip:"#FFEFD5",PeachPuff:"#FFDAB9",Peru:"#CD853F",Pink:"#FFC0CB",Plum:"#DDA0DD",PowderBlue:"#B0E0E6",Purple:"#800080",RebeccaPurple:"#663399",Red:"#FF0000",RosyBrown:"#BC8F8F",RoyalBlue:"#4169E1",SaddleBrown:"#8B4513",Salmon:"#FA8072",SandyBrown:"#F4A460",SeaGreen:"#2E8B57",SeaShell:"#FFF5EE",Sienna:"#A0522D",Silver:"#C0C0C0",SkyBlue:"#87CEEB",SlateBlue:"#6A5ACD",SlateGray:"#708090",SlateGrey:"#708090",Snow:"#FFFAFA",SpringGreen:"#00FF7F",SteelBlue:"#4682B4",Tan:"#D2B48C",Teal:"#008080",Thistle:"#D8BFD8",Tomato:"#FF6347",Turquoise:"#40E0D0",Violet:"#EE82EE",Wheat:"#F5DEB3",White:"#FFFFFF",WhiteSmoke:"#F5F5F5",Yellow:"#FFFF00",YellowGreen:"#9ACD32"},v=e=>{e.fill&&(S.fillStyle=e.fill,S.fill()),e.border&&(S.strokeStyle=e.border,S.lineWidth=e.borderWidth??W("xs")/10,S.stroke())},x=(e,t,o)=>e<t?t:e>o?o:e,T={noop:"#AF6C31",taxes:"#AE0000",garden:"#2F8043",shop:"#D7DE87",extraSteps:"#6E5381",money:F.Tan,extraKey:F.Gold,exit:"#005A8D",draft:F.LightSteelBlue},k=F.Black,E="#1D1D1D";const A=new class{#s;#r;#i;#a;#n;#l;#d;#h;#c;#u;#p;mouseGridRow;mouseGridCol;constructor(){this.newGame()}newGame(){this.#s=5,this.#r=13,this.#i=Array.from({length:this.#s},(e,t)=>Array.from({length:this.#r},(e,o)=>{const s=new m;return s.coord.row=t,s.coord.col=o,s})),this.#a={row:2,col:0},this.atCoord(this.player).events={enter:"noop",exit:"noop",use:"noop"},this.atCoord(this.player).revealed=!0,this.atCoord(this.player).hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"unknown",enabled:!0},SOUTH_EAST:{status:"unknown",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"blocked",enabled:!0},NORTH_WEST:{status:"blocked",enabled:!0}},this.#n={row:2,col:9},this.atCoord(this.exit).events={enter:"exit",exit:"noop",use:"noop"},this.atCoord(this.exit).revealed=!0,this.atCoord(this.exit).hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"blocked",enabled:!0},SOUTH_EAST:{status:"blocked",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"unknown",enabled:!0},NORTH_WEST:{status:"unknown",enabled:!0}},this.#p={index:0,position:{row:0,col:0},direction:"NORTH",options:[new m,new m,new m]},this.#p.options.forEach(e=>e.revealed=!0),this.#d={steps:40,keys:1,gems:0},this.mouseGridRow=-1,this.mouseGridCol=-1,this.#u=0,this.#c="noop",this.setState("move"),this.play()}get rows(){return this.#s}get cols(){return this.#r}get player(){return this.#a}get exit(){return this.#n}movePlayerTo(e,t){this.#a.row=e,this.#a.col=t}movePlayerToCoord(e){this.movePlayerTo(e.row,e.col)}at(e,t){return this.#i[e][t]}atCoord(e){return this.at(e.row,e.col)}placeRoom(e){this.validCoord(e.coord)&&(this.#i[e.coord.row][e.coord.col]=e)}valid(e,t){return 0<=e&&e<this.#s&&0<=t&&t<this.#r}validCoord(e){return this.valid(e.row,e.col)}setState(e){this.#l=e}getState(){return this.#l}#y(e,t,o){this.at(e,t).revealed=o}#f(e,t){this.#y(e,t,!0)}#g(e,t){this.#y(e,t,!1)}isRevealed(e,t){return this.at(e,t).revealed}isRevealedCoord(e){return this.isRevealed(e.row,e.col)}isHidden(e,t){return!this.isRevealed(e,t)}isHiddenCoord(e){return this.isHidden(e.row,e.col)}getResource(e){return this.#d[e]??0}addResource(e,t=1){e in this.#d||(this.#d[e]=0),this.#d[e]+=t}removeResource(e,t=1){e in this.#d&&(this.#d[e]-=t,this.#d[e]<0&&(this.#d[e]=0))}setResource(e,t){this.#d[e]=t}getResources(){return Object.entries(this.#d).map(([e,t])=>({type:e,count:t}))}pause(){this.#h=!1}play(){this.#h=!0}get isRunning(){return this.#h}get draft(){return this.#p}get lastTimeStamp(){return this.#u}set lastTimeStamp(e){this.#u=e}get lastEffect(){return this.#c}set lastEffect(e){this.#c=e}get playerRoom(){return this.atCoord(this.#a)}canPlayerDraftTowards(e){if(!e)return!1;const t=b(this.player,e);if(!this.validCoord(t))return!1;if(this.atCoord(t).revealed)return!1;const o=this.playerRoom;return o.hallways[e].enabled&&"unknown"===o.hallways[e].status}},C=e=>A.atCoord(e),D={NORTH:{row:-1,col:0},NORTH_EAST:{row:0,col:1},SOUTH_EAST:{row:1,col:1},SOUTH:{row:1,col:0},SOUTH_WEST:{row:1,col:-1},NORTH_WEST:{row:0,col:-1}},R={NORTH:{row:-1,col:0},NORTH_EAST:{row:-1,col:1},SOUTH_EAST:{row:0,col:1},SOUTH:{row:1,col:0},SOUTH_WEST:{row:0,col:-1},NORTH_WEST:{row:-1,col:-1}},b=(e,t)=>{const o=e.col%2==0?R[t]:D[t];return r=o,{row:(s=e).row+r.row,col:s.col+r.col};var s,r},B=e=>{if("NORTH"===e)return"SOUTH";if("NORTH_EAST"===e)return"SOUTH_WEST";if("SOUTH_EAST"===e)return"NORTH_WEST";if("SOUTH"===e)return"NORTH";if("SOUTH_WEST"===e)return"NORTH_EAST";if("NORTH_WEST"===e)return"SOUTH_EAST";throw new Error},M=(e,t)=>{const s=(()=>{const e=Object.values(y).reduce((e,t)=>e+t.rarity,0);let t=c()*e;for(const e of Object.keys(y))if(t-=y[e].rarity,t<=0)return e;throw new Error})(),r=A.draft.options[e];r.events={enter:s,exit:"noop",use:"noop"},"extraKey"===s?r.items.push("keys"):r.items.length=0,o.forEach(e=>{((e,t,o)=>{const s=b(e,t);if(A.validCoord(s))if(c()<.4){const e=C(s);A.isHiddenCoord(s)?(o.hallways[t].enabled=!0,o.hallways[t].status="unknown"):e.hallways[B(t)].enabled?(o.hallways[t].enabled=!0,o.hallways[t].status="open"):(o.hallways[t].enabled=!0,o.hallways[t].status="blocked")}else o.hallways[t].enabled=!1,o.hallways[t].status="blocked";else o.hallways[t].enabled=!1,o.hallways[t].status="blocked"})(A.draft.position,e,r)}),r.hallways[B(t)].enabled=!0,r.hallways[B(t)].status="open",r.needsKey="extraKey"!==s&&u()%2==0,r.coord.row=-1,r.coord.col=e},H=()=>{const e=A.draft.direction;A.draft.index=0;let t=!0;do{for(let t=0;t<A.draft.options.length;t++)K.delete(n({row:-1,col:t})),M(t,e);t=0!==A.getResource("keys")||-1!==A.draft.options.findIndex(e=>!e.needsKey)}while(!t)};const O=e=>{if(!A.isRunning)return;const t=b(A.player,e);if(!A.validCoord(t))return;if(A.getResource("steps")<=0)return;const o=C(A.player).hallways;o[e].enabled&&"blocked"!==o[e].status&&(A.isHiddenCoord(t)?(A.draft.position=t,A.draft.direction=e,A.setState("draft"),H()):C(t).hallways[B(e)].enabled&&(C(t).enter(),A.movePlayerToCoord(t),A.removeResource("steps"),oe.nextSprite()))};const P={xs:1,sm:2,md:3,lg:4,xl:5},W=e=>oe.playArea.width/160*P[e],G=(t,s,r,i,a=!1)=>{i.revealed?(oe.useSprites?q(t,s,r,i.coord,i.events.enter):J(t,s,r,{fill:T[i.events.enter],...a&&{border:F.Wheat,borderWidth:3}}),(-1===i.coord.row||oe.displayHallways)&&(o.forEach(e=>{((e,t,s,r,i)=>{if(!e.enabled)return;const a={open:{factor:1,color:"#A6835B"},blocked:{factor:.5,color:F.FireBrick},unknown:{factor:.75,color:"#A6835B"}},n=Math.sqrt(3)*r/2,l=a[e.status].factor;var d,h,c,u,p;S.fillStyle=a[e.status].color,S.lineWidth=W("xs")/2,S.strokeStyle="#69401E",d=t,h=s,c=r/5,u=n*l,p=o.indexOf(i)*Math.PI/3,S.save(),S.translate(d,h),S.rotate(p),S.strokeRect(-c/2,-u,c,u),S.fillRect(-c/2,-u,c,u),S.restore()})(i.hallways[e],t,s,r,e)}),X(t,s,r/5,{fill:F.Lavender,border:"black",borderWidth:.5}))):e&&J(t,s,r,void 0,{fill:E,border:F.Wheat})},L=(e,t)=>{S.save(),S.translate(e.x,e.y),t(e.width,e.height),S.restore()},N=(e,t)=>{S.textAlign="center",S.textBaseline="top",S.fillStyle="white",S.font=`${W("xl")}px monospace`,S.fillText("Controls",e/2,0);const o=W("sm");S.textAlign="left",S.font=`${o}px monospace`;let s=2;ae.hotkeysByScope.forEach((e,t)=>{s+=1,S.fillText(`${t.substring(0,1).toUpperCase()+t.substring(1)} keys:`,0,s*o),e.forEach(e=>{s+=1,S.fillText(`[${e.keys[0]}] ${e.name}`,o,s*o)}),s+=1})},_=(e,t,o,s,r,i)=>{const a=o-e,n=s-t,l=Math.hypot(a,n),d=Math.atan2(n,a);S.save(),S.translate(e,t),S.rotate(d),S.beginPath(),S.lineWidth=W("xs")/5;for(let e=0;e<=l;e++){const t=e,o=Math.sin(e/l*2*Math.PI*r)*i;0===e?S.moveTo(t,o):S.lineTo(t,o)}S.stroke(),S.restore()},U=new Map,$=(e,t,o)=>{const s=o/8,a=o/16;S.lineCap="round";const l=Object.values(r),d=Object.values(i),h=((e,t,o)=>{let s=U.get(e);if(!s){const r=["straight","wavy","dotted","dashed"];s={fillColor:p(Object.values(T)),innerSymbol:p(t),outerSymbol:p(o),lineType:p(r)},U.set(e,s)}return s})(n(A.player),l,d);if(null===S){J(e,t,o,{fill:h.fillColor,border:"white",borderWidth:2}),S.setLineDash([s,a]);for(let s=0;s<6;s++){const r=Math.PI/180*(60*s+30),i=e+.6*o*Math.cos(r),a=t+.6*o*Math.sin(r);S.font=`${W("sm")}px monospace`,S.textAlign="center",S.textBaseline="middle",S.fillStyle="white",S.fillText(`${h.outerSymbol}`,i,a)}S.setLineDash([]),S.strokeStyle="white";for(let s=0;s<6;s++){const r=Math.PI/180*(60*s),i=e+1.5*W("xs")*Math.cos(r),a=t+1.5*W("xs")*Math.sin(r),n=e+o*Math.cos(r),l=t+o*Math.sin(r);if("wavy"===h.lineType)_(i,a,n,l,5,W("xs")/2);else{switch(h.lineType){case"straight":S.lineWidth=W("xs")/5,S.setLineDash([]);break;case"dotted":S.setLineDash([o/30]);break;case"dashed":S.setLineDash([o/5])}S.beginPath(),S.moveTo(i,a),S.lineTo(n,l),S.stroke()}}S.setLineDash([]),X(e,t,W("xs"),{fill:"white"}),S.font=`${W("sm")}px monospace`,S.textAlign="center",S.textBaseline="middle",S.fillText(`${h.innerSymbol}`,e,t)}else q(e,t,o,A.player,A.playerRoom.events.enter)},K=new Map,I={extraSteps:[{row:3,col:4}],extraKey:[{row:3,col:6}],money:[{row:2,col:6}],taxes:[{row:1,col:2}],garden:[{row:4,col:7}],shop:[{row:1,col:0}],start:[{row:4,col:7}],exit:[{row:2,col:7}],noop:[{row:0,col:0}]},q=(e,t,o,s,r)=>{const i=oe.spriteWidth/2,a=oe.spriteHeight-i,l=2*o,d=Math.round(l/oe.spriteWidth*100)/100,h=oe.spriteHeight*d,c=e-i*d,u=t-a*d;let y,f;const g=n(s);if(K.has(g)){const e=K.get(g);y=e.row,f=e.col}else{const e=p(I[r]);y=e.row,f=e.col,K.set(g,e)}S.drawImage(oe.spriteSheet,f*oe.spriteWidth,y*oe.spriteHeight+1,oe.spriteWidth,oe.spriteHeight,c,u,l,h)},Y=(e,t)=>{S.textAlign="center",S.textBaseline="top",S.fillStyle="white",S.font=`${W("md")}px monospace`,S.fillText("Resources",e/2,0),S.textAlign="left",S.font=`${W("sm")}px monospace`;const o=[];for(const{type:e,count:t}of A.getResources())o.push(`â€¢ ${s[e]} ${e.substring(0,1).toUpperCase()+e.substring(1)}: ${t}`);o.forEach((t,o)=>{S.fillText(t,e/2.5,(o+1)*W("lg"))});const r=e/2;$(r,3*(t/5),.5*r)},j=(t,o)=>{S.strokeStyle="#CECECE",S.lineWidth=W("xs")/5;const s=A.cols,r=A.rows,i=t/10/2;for(let t=0;t<r;t++)for(let o=0;o<s;o++){const s=Math.sqrt(3)*i,r=(1.5*o+1)*i,a=t*s+(o%2+1)*(s/2);if(G(1*r,1*a,i,A.at(t,o)),t===A.player.row&&o===A.player.col&&X(1*r,1*a,W("xs"),{fill:k}),A.mouseGridRow===t&&A.mouseGridCol===o){const s={row:t,col:o};e&&(S.fillStyle="white",S.textBaseline="middle",S.textAlign="center",S.fillText(n(s),1*r,1*a)),"move"===A.getState()&&A.canPlayerDraftTowards(d(A.player,s))&&(S.save(),S.globalAlpha=V,J(1*r,1*a,.75*i,{fill:T.draft}),S.restore())}"draft"===A.getState()&&t===A.draft.position.row&&o===A.draft.position.col&&(S.save(),S.fillStyle=T.draft,S.globalAlpha=V,G(1*r,1*a,.75*i,A.draft.options[A.draft.index]),S.restore())}};let V=1,z=0;const J=(e,t,o,s,r=void 0,i="flat")=>{const a="flat"===i?0:30;S.save(),S.beginPath();for(let s=0;s<6;s++){const r=Math.PI/180*(60*s+a),i=e+o*Math.cos(r),n=t+o*Math.sin(r);0===s?S.moveTo(i,n):S.lineTo(i,n)}S.closePath(),r?v(r):s&&v(s),S.restore()},X=(e,t,o,s)=>{S.save(),S.beginPath(),S.arc(e,t,o,0,2*Math.PI),S.closePath(),v(s),S.restore()},Q=(e,t)=>{if("draft"!==A.getState())return;const o=e/16,r=t/2;for(let e=0;e<A.draft.options.length;++e){const t=3*e+4.5,i=A.draft.options[e],a=t*o,n=r,l=.5*o;if(G(a,n,l,i,!0),e===A.draft.index){if("noop"!==y[i.events.enter].description){const e=1.75*r;S.textAlign="center",S.textBaseline="middle",S.fillStyle="white",S.font=`${W("sm")}px monospace`,S.fillText(y[i.events.enter].description,a,e)}if(i.needsKey){const e=(t-1.25)*o,i=r;S.font=`${W("lg")}px monospace`,S.textAlign="center",S.textBaseline="middle",S.fillText(s.lock,e,i)}if(i.items.includes("keys")){const e=(t+1.25)*o,i=r;S.font=`${W("lg")}px monospace`,S.textAlign="center",S.textBaseline="middle",S.fillText(s.keys,e,i)}const e=i.needsKey&&0===A.getResource("keys");S.save(),S.globalAlpha=V,J(a,n,1.2*l,{border:e?"red":"yellow",borderWidth:6}),S.restore()}}if(A.getResource("gems")>=2){((e,t,o=50)=>{const s=o/2,r=[{startAngle:.4*Math.PI,endAngle:Math.PI,sign:-1},{startAngle:1.4*Math.PI,endAngle:2*Math.PI,sign:1}];for(const i of r){const r=z+i.startAngle,a=z+i.endAngle;S.beginPath(),S.arc(e,t,o,r,a),S.strokeStyle="white",S.lineWidth=W("xs")/3,S.stroke(),S.save(),S.translate(e,t),S.rotate(z),S.beginPath();const n=s/2,l=Math.sqrt(3)/2*s;S.moveTo(i.sign*o-n,0),S.lineTo(i.sign*o+n,0),S.lineTo(i.sign*o,i.sign*l),S.closePath(),S.fillStyle="white",S.fill(),S.restore()}})(14.5*o,r,r/3),S.textAlign="center",S.textBaseline="middle",S.fillStyle="white",S.font=`${W("sm")}px monospace`,S.fillText(`2Ã—${s.gems}`,14.5*o,r),S.fillText("[R]",14.5*o,2*r)}},Z=(e,t)=>{S.textAlign="center",S.textBaseline="top",S.fillStyle="white",S.font=`${W("sm")}px monospace`;["Draft rooms by selecting an option and press [Space] or [Enter].","Some rooms are locked behind a key, so look out for them to help on your journey!","Different rooms can help or hinder you. Gems help you refresh your draft options. Spend them wisely!","Red paths are blocked from the other side. Gray ones are yet unvisited, while whites are already known.","Do not be afraid to explore for additional resources!"].forEach((t,o)=>{S.fillText(t,e/2,o*W("lg")+W("xs"))})},ee=new Map,te=()=>{if(t){w.width=window.innerWidth,w.height=window.innerHeight,S.imageSmoothingEnabled=!1;const e=(()=>{const e=16/9,t=w.width,o=w.height;if(t/o>e){const s=o*e;return{x:(t-s)/2,y:0,width:s,height:o}}{const s=t/e;return{x:0,y:(o-s)/2,width:t,height:s}}})();oe.playArea=e;const{x:t,y:o,width:s,height:r}=e,i=s/16,a=r/9,n={draft:{x:t,y:o,width:s,height:2*a},grid:{x:t+3*i,y:o+2*a,width:10*i,height:5*a},resources:{x:t,y:o+2*a,width:3*i,height:5*a},movement:{x:t+13*i,y:o+2*a,width:3*i,height:5*a},footer:{x:t,y:o+7*a,width:s,height:2*a}};oe.layout=n,oe.unitWidth=i,oe.unitHeight=a,oe.canvasWidth=w.width,oe.canvasHeight=w.height}S.fillStyle=E,S.fillRect(0,0,oe.canvasWidth,oe.canvasHeight);const o=oe.layout,s=A.rows,r=A.cols,i=Math.min(128,Math.floor(Math.min(w.width/r,w.height/s))),a=Math.floor((w.width-i*r)/2),l=Math.floor((w.height-i*s)/2);if(L(o.draft,Q),L(o.resources,Y),L(o.grid,j),L(o.movement,N),L(o.footer,Z),e){S.strokeStyle=F.Pink,S.lineWidth=W("xs")/5;for(const[e,t]of Object.entries(o))S.strokeRect(t.x,t.y,t.width,t.height),S.textAlign="left",S.textBaseline="top",S.fillStyle=F.Pink,S.font=`${W("sm")}px monospace`,S.fillText(`[${e}]`,t.x+5,t.y+5)}if("noop"!==A.lastEffect&&(S.textAlign="right",S.textBaseline="middle",S.fillStyle="white",S.font=`${W("sm")}px monospace`,S.fillText(`${A.lastEffect}`,a+r*i-i/2,l-i/2)),t){ee.clear();const e=oe.unitWidth/2;for(let t=0;t<s;t++)for(let o=0;o<r;o++){const s=Math.sqrt(3)*e,r=(1.5*o+1)*e,i=t*s+(o%2+1)*(s/2),a=new Path2D;for(let t=0;t<6;t++){const o=Math.PI/180*(60*t),s=r+e*Math.cos(o),n=i+e*Math.sin(o);0===t?a.moveTo(s,n):a.lineTo(s,n)}a.closePath(),ee.set(n({row:t,col:o}),a)}}return t=!1,!0},oe=new class{layout;mousePosition;unitWidth;unitHeight;canvasWidth;canvasHeight;playArea;spriteSheet;spriteWidth=32;spriteHeight=48;renderedSpriteRow=0;renderedSpriteCol=0;maxSpriteRow=5;maxSpriteCol=8;useSprites=!1;displayHallways=!0;constructor(){this.mousePosition={x:-1,y:-1}}nextSprite(){const e=this.maxSpriteRow*this.maxSpriteCol,t=(this.renderedSpriteRow*this.maxSpriteCol+this.renderedSpriteCol+1)%e;this.renderedSpriteRow=Math.floor(t/this.maxSpriteCol),this.renderedSpriteCol=t%this.maxSpriteCol}isReady(){return!t}},se=e=>{if(!oe.isReady())return;oe.mousePosition={x:e.offsetX,y:e.offsetY};const t=((e,t)=>{for(let o=0;o<A.rows;o++)for(let s=0;s<A.cols;s++){const r={row:o,col:s};if(S.isPointInPath(ee.get(n(r)),e,t))return r}return{row:-1,col:-1}})(e.offsetX-oe.layout.grid.x,e.offsetY-oe.layout.grid.y);var s,r;A.mouseGridRow=t.row,A.mouseGridCol=t.col,"move"===A.getState()&&A.validCoord(t)?A.canPlayerDraftTowards(d(A.player,t))?w.style.cursor="pointer":(s=A.player,r=t,o.some(e=>l(b(s,e),r))&&A.atCoord(t).revealed?w.style.cursor="pointer":w.style.cursor="default"):w.style.cursor="default"},re=()=>{t=!0},ie=e=>{if(!oe.isReady())return;if("move"===A.getState()){const e={row:A.mouseGridRow,col:A.mouseGridCol};A.validCoord(e)&&o.some(t=>{const o=b(A.player,t);return!!l(o,e)&&(O(t),!0)})}const t=W("sm"),s={x:oe.playArea.x+oe.playArea.width-2*t,y:oe.playArea.y+t,width:t,height:t};a(oe.mousePosition.x,oe.mousePosition.y,s)&&(oe.useSprites=!oe.useSprites)};const ae=new class{hotkeysByScope=new Map;register=(...e)=>{e.forEach(e=>{this.hotkeysByScope.has(e.scope)||this.hotkeysByScope.set(e.scope,[]),this.hotkeysByScope.get(e.scope).push(e)})};handleKeydown=e=>{const t=(this.hotkeysByScope.get("global")||[]).find(t=>t.keys.includes(e.key));if(t)return e.preventDefault(),void t.handler();const o=(this.hotkeysByScope.get(A.getState())||[]).find(t=>t.keys.includes(e.key));o&&(e.preventDefault(),o.handler())}};let ne=performance.now();const le=e=>{const t=1e3/(e-ne);if(ne=e,A.lastTimeStamp=e,(e=>{for(const t of g)t.active&&t.update(e);g=g.filter(e=>e.active)})(e),te()){S.textAlign="left",S.textBaseline="top",S.fillStyle=F.Pink,S.font=`${W("sm")}px monospace`,S.fillText(`FPS: ${Math.round(t)}`,oe.layout.draft.x,oe.layout.draft.y);const e=W("sm"),o={x:oe.playArea.x+oe.playArea.width-2*e,y:oe.playArea.y+e,width:e,height:e};S.fillStyle=oe.useSprites?F.Wheat:F.MediumVioletRed,S.fillRect(o.x,o.y,o.width,o.height),a(oe.mousePosition.x,oe.mousePosition.y,o)&&(w.style.cursor="pointer")}else S.textAlign="center",S.textBaseline="middle",S.fillStyle=F.Red,S.font=`${W("sm")}px monospace`,S.fillText("Play area not suitable for this game, buy a proper display.",w.width/2,w.height/2);requestAnimationFrame(le)},de=()=>{document.addEventListener("keydown",ae.handleKeydown),document.addEventListener("mousemove",se),document.addEventListener("mouseup",ie),window.addEventListener("resize",re),ae.register({keys:["h"],name:"Toggle Debug Mode",description:"Toggles Debug Mode on or off",scope:"global",handler:()=>{e=!e}},{keys:["t"],name:"Toggle Sprite Mode",description:"Toggles Sprite Mode on or off",scope:"global",handler:()=>{oe.useSprites=!oe.useSprites}},{keys:["u"],name:"Toggle Hallway Mode",description:"Toggles Hallway Mode on or off",scope:"global",handler:()=>{oe.displayHallways=!oe.displayHallways}},{keys:["g"],name:"Add 5 Gems",description:"Adds 5 gems to the player inventory",scope:"global",handler:()=>{A.addResource("gems",5)}},{keys:["k"],name:"Add 5 Keys",description:"Adds 5 keys to the player inventory",scope:"global",handler:()=>{A.addResource("keys",5)}}),ae.register({keys:["w","ArrowUp"],name:"Move North",description:"Move the player north",scope:"move",handler:()=>O("NORTH")},{keys:["e"],name:"Move North-East",description:"Move the player north-east",scope:"move",handler:()=>O("NORTH_EAST")},{keys:["d"],name:"Move South-East",description:"Move the player south-east",scope:"move",handler:()=>O("SOUTH_EAST")},{keys:["s","ArrowDown"],name:"Move South",description:"Move the player south",scope:"move",handler:()=>O("SOUTH")},{keys:["a"],name:"Move South-West",description:"Move the player south-west",scope:"move",handler:()=>O("SOUTH_WEST")},{keys:["q"],name:"Move North-West",description:"Move the player north-west",scope:"move",handler:()=>O("NORTH_WEST")},{keys:["r"],name:"Restart Game",description:"Start a new game",scope:"move",handler:()=>A.newGame()}),ae.register({keys:["d","ArrowRight"],name:"Next Draft Option",description:"Move draft selection to the next option",scope:"draft",handler:()=>{A.draft.index=x(A.draft.index+1,0,A.draft.options.length-1)}},{keys:["a","ArrowLeft"],name:"Previous Draft Option",description:"Move draft selection to the previous option",scope:"draft",handler:()=>{A.draft.index=x(A.draft.index-1,0,A.draft.options.length-1)}},{keys:[" ","Enter"],name:"Place Room",description:"Place the selected room",scope:"draft",handler:()=>(()=>{const e=A.draft.options[A.draft.index].copy();e.needsKey&&0===A.getResource("keys")||(e.needsKey&&(e.needsKey=!1,A.removeResource("keys")),e.coord.row=A.draft.position.row,e.coord.col=A.draft.position.col,A.placeRoom(e),O(A.draft.direction),A.draft.index=0,o.forEach(t=>{const o=b(A.draft.position,t);if(A.validCoord(o)&&A.isRevealedCoord(o)){const s=C(o);!e.hallways[t].enabled&&s.hallways[B(t)].enabled?s.hallways[B(t)].status="blocked":e.hallways[t].enabled&&s.hallways[B(t)].enabled&&(s.hallways[B(t)].status="open")}}),A.setState("move"))})()},{keys:["r"],name:"Refresh Draft",description:"Refresh draft options by spending 2 gems",scope:"draft",handler:()=>{A.getResource("gems")>=2&&(A.removeResource("gems",2),H())}})};(async()=>{de(),oe.spriteSheet=new Image,oe.spriteSheet.src="./hextiles.png",oe.spriteSheet.onload=()=>{le(0)}})().then(()=>console.log("Game started."));