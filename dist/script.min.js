let DEBUG_MODE=!1;const DIRECTION_VALUES=["NORTH","NORTH_EAST","SOUTH_EAST","SOUTH","SOUTH_WEST","NORTH_WEST"],ItemTexts={steps:"👣",keys:"🔑",lock:"🔒",gems:"💎"},SymbolTexts={spiral:"🌀",diamond:"🔶",loop:"➰",bright:"🔆",circle:"🔴",square:"🟩"},AltSymbolTexts={target:"🎯",star:"✴️",slash:"〰️",paint:"🎨",egg:"🥚",grid:"🔳"},isInside=(e,t,o)=>o.x<=e&&o.y<=t&&e<=o.x+o.width&&t<=o.y+o.height;class SeededRNG{#e;constructor(e=0){this.setSeed(e)}setSeed(e){this.#e=e??Math.floor(Math.random()*Math.pow(2,31))+1}float(){return this.#e^=this.#e<<13,this.#e^=this.#e>>17,this.#e^=this.#e<<5,(this.#e>>>0)/4294967295}int32(){return this.#e^=this.#e<<13,this.#e^=this.#e>>17,this.#e^=this.#e<<5,0|this.#e}get seed(){return this.#e}}const rng=new SeededRNG(Date.now()),setSeed=e=>rng.setSeed(e),randomFloat=()=>rng.float(),randomRange=(e,t)=>Math.floor(randomFloat()*(t-e))+e,randomInt32=(e=0)=>e?randomRange(0,e):rng.int32(),randomBool=()=>randomInt32()%2==0,randomElement=e=>e[randomInt32(e.length)],randomHexColor=()=>{let e="#";for(let t=0;t<6;t++)e+=randomElement([..."0123456789ABCDEF"]);return e},Effects={extraSteps:{invoke:()=>gameState.addResource("steps",2),description:"Take a rest.",triggerText:"You have gained 2 extra steps.",triggerLimit:-1,rarity:.5},extraKey:{invoke:()=>gameState.addResource("keys"),description:"Alohomora.",triggerText:"You have found a key.",triggerLimit:1,rarity:.3},money:{invoke:()=>gameState.addResource("gems"),description:"What's that spark in the corner?",triggerText:"You have found a gem.",triggerLimit:1,rarity:.3},taxes:{invoke:()=>gameState.removeResource("gems"),description:"Takes a toll on you.",triggerText:`You have to pay taxes: ${ItemTexts.gems}`,triggerLimit:-1,rarity:.3},garden:{invoke:()=>gameState.setResource("steps",41),description:"Like starting again.",triggerText:"Your steps have been reset.",triggerLimit:-1,rarity:.4},shop:{invoke:()=>{gameState.getResource("gems")>=5&&(gameState.addResource("keys"),gameState.removeResource("gems",5))},description:"Buy your passage.",triggerText:"You can buy a key for #5 with [Space].",triggerLimit:1,rarity:.9},exit:{invoke:()=>{gameState.pause()},description:"",triggerText:"You have won!",triggerLimit:-1,rarity:0},noop:{invoke:()=>{},description:"A simple room.",triggerText:"",triggerLimit:-1,rarity:.7}};class Tween{constructor({from:e,to:t,duration:o,ease:n=e=>e,onUpdate:a,onComplete:r,loop:s=!1,reverse:i=!1,type:l=""}){this.from=e,this.to=t,this.duration=o,this.ease=n,this.onUpdate=a,this.onComplete=r,this.loop=s,this.reverse=i,this.active=!0,this.startTime=performance.now(),this.type=l}update(e){const t=Math.min((e-this.startTime)/this.duration,1),o=this.ease(t),n=this.from+(this.to-this.from)*o;this.onUpdate(n),1===t&&(this.loop?(this.reverse&&([this.from,this.to]=[this.to,this.from]),this.startTime=e):(this.active=!1,this.onComplete?.()))}}let animations=[new Tween({from:.1,to:1,duration:800,loop:!0,reverse:!0,onUpdate:e=>selectionAlpha=e,type:"selection-pulse"}),new Tween({from:0,to:2*Math.PI,duration:2e3,loop:!0,onUpdate:e=>refreshRotation=e,type:"refresh-rotate"})];class Room{events;hallways;revealed;triggerCount;needsKey;items;constructor(e=void 0){e?(this.events=e.events,this.hallways=e.hallways,this.revealed=e.revealed,this.triggerCount=e.triggerCount,this.needsKey=e.needsKey,this.items=e.items):this.#t()}#t(){this.events={enter:"noop",exit:"noop",use:"noop"},this.hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"unknown",enabled:!0},SOUTH_EAST:{status:"unknown",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"unknown",enabled:!0},NORTH_WEST:{status:"unknown",enabled:!0}},this.revealed=!1,this.triggerCount=0,this.needsKey=!1,this.items=[]}#o(e){-1===Effects[e].triggerLimit?(Effects[e].invoke(),gameState.lastEffect=Effects[e].triggerText):this.triggerCount<Effects[e].triggerLimit?(Effects[e].invoke(),gameState.lastEffect=Effects[e].triggerText,this.triggerCount+=1):gameState.lastEffect=""}enter(){this.#o(this.events.enter)}use(){this.#o(this.events.use)}exit(){this.#o(this.events.exit)}copy(){return new Room(JSON.parse(JSON.stringify(this)))}}const canvas=document.querySelector("#canvas"),context=canvas.getContext("2d"),CSS_COLOR_NAMES={AliceBlue:"#F0F8FF",AntiqueWhite:"#FAEBD7",Aqua:"#00FFFF",Aquamarine:"#7FFFD4",Azure:"#F0FFFF",Beige:"#F5F5DC",Bisque:"#FFE4C4",Black:"#000000",BlanchedAlmond:"#FFEBCD",Blue:"#0000FF",BlueViolet:"#8A2BE2",Brown:"#A52A2A",BurlyWood:"#DEB887",CadetBlue:"#5F9EA0",Chartreuse:"#7FFF00",Chocolate:"#D2691E",Coral:"#FF7F50",CornflowerBlue:"#6495ED",Cornsilk:"#FFF8DC",Crimson:"#DC143C",Cyan:"#00FFFF",DarkBlue:"#00008B",DarkCyan:"#008B8B",DarkGoldenRod:"#B8860B",DarkGray:"#A9A9A9",DarkGrey:"#A9A9A9",DarkGreen:"#006400",DarkKhaki:"#BDB76B",DarkMagenta:"#8B008B",DarkOliveGreen:"#556B2F",DarkOrange:"#FF8C00",DarkOrchid:"#9932CC",DarkRed:"#8B0000",DarkSalmon:"#E9967A",DarkSeaGreen:"#8FBC8F",DarkSlateBlue:"#483D8B",DarkSlateGray:"#2F4F4F",DarkSlateGrey:"#2F4F4F",DarkTurquoise:"#00CED1",DarkViolet:"#9400D3",DeepPink:"#FF1493",DeepSkyBlue:"#00BFFF",DimGray:"#696969",DimGrey:"#696969",DodgerBlue:"#1E90FF",FireBrick:"#B22222",FloralWhite:"#FFFAF0",ForestGreen:"#228B22",Fuchsia:"#FF00FF",Gainsboro:"#DCDCDC",GhostWhite:"#F8F8FF",Gold:"#FFD700",GoldenRod:"#DAA520",Gray:"#808080",Grey:"#808080",Green:"#008000",GreenYellow:"#ADFF2F",HoneyDew:"#F0FFF0",HotPink:"#FF69B4",IndianRed:"#CD5C5C",Indigo:"#4B0082",Ivory:"#FFFFF0",Khaki:"#F0E68C",Lavender:"#E6E6FA",LavenderBlush:"#FFF0F5",LawnGreen:"#7CFC00",LemonChiffon:"#FFFACD",LightBlue:"#ADD8E6",LightCoral:"#F08080",LightCyan:"#E0FFFF",LightGoldenRodYellow:"#FAFAD2",LightGray:"#D3D3D3",LightGrey:"#D3D3D3",LightGreen:"#90EE90",LightPink:"#FFB6C1",LightSalmon:"#FFA07A",LightSeaGreen:"#20B2AA",LightSkyBlue:"#87CEFA",LightSlateGray:"#778899",LightSlateGrey:"#778899",LightSteelBlue:"#B0C4DE",LightYellow:"#FFFFE0",Lime:"#00FF00",LimeGreen:"#32CD32",Linen:"#FAF0E6",Magenta:"#FF00FF",Maroon:"#800000",MediumAquaMarine:"#66CDAA",MediumBlue:"#0000CD",MediumOrchid:"#BA55D3",MediumPurple:"#9370DB",MediumSeaGreen:"#3CB371",MediumSlateBlue:"#7B68EE",MediumSpringGreen:"#00FA9A",MediumTurquoise:"#48D1CC",MediumVioletRed:"#C71585",MidnightBlue:"#191970",MintCream:"#F5FFFA",MistyRose:"#FFE4E1",Moccasin:"#FFE4B5",NavajoWhite:"#FFDEAD",Navy:"#000080",OldLace:"#FDF5E6",Olive:"#808000",OliveDrab:"#6B8E23",Orange:"#FFA500",OrangeRed:"#FF4500",Orchid:"#DA70D6",PaleGoldenRod:"#EEE8AA",PaleGreen:"#98FB98",PaleTurquoise:"#AFEEEE",PaleVioletRed:"#DB7093",PapayaWhip:"#FFEFD5",PeachPuff:"#FFDAB9",Peru:"#CD853F",Pink:"#FFC0CB",Plum:"#DDA0DD",PowderBlue:"#B0E0E6",Purple:"#800080",RebeccaPurple:"#663399",Red:"#FF0000",RosyBrown:"#BC8F8F",RoyalBlue:"#4169E1",SaddleBrown:"#8B4513",Salmon:"#FA8072",SandyBrown:"#F4A460",SeaGreen:"#2E8B57",SeaShell:"#FFF5EE",Sienna:"#A0522D",Silver:"#C0C0C0",SkyBlue:"#87CEEB",SlateBlue:"#6A5ACD",SlateGray:"#708090",SlateGrey:"#708090",Snow:"#FFFAFA",SpringGreen:"#00FF7F",SteelBlue:"#4682B4",Tan:"#D2B48C",Teal:"#008080",Thistle:"#D8BFD8",Tomato:"#FF6347",Turquoise:"#40E0D0",Violet:"#EE82EE",Wheat:"#F5DEB3",White:"#FFFFFF",WhiteSmoke:"#F5F5F5",Yellow:"#FFFF00",YellowGreen:"#9ACD32"},randomColor=()=>randomElement(Object.values(CSS_COLOR_NAMES)),useColors=e=>{e.fill&&(context.fillStyle=e.fill,context.fill()),e.border&&(context.strokeStyle=e.border,context.lineWidth=e.borderWidth??getFontSizeInPixels("xs")/10,context.stroke())},clamp=(e,t,o)=>e<t?t:e>o?o:e,ROOM_COLORS={noop:"#AF6C31",taxes:"#AE0000",garden:"#2F8043",shop:"#D7DE87",extraSteps:"#6E5381",money:CSS_COLOR_NAMES.Tan,extraKey:CSS_COLOR_NAMES.Gold,exit:"#005A8D",draft:CSS_COLOR_NAMES.LightSteelBlue},PLAYER_COLOR=CSS_COLOR_NAMES.Black,CLEAR_COLOR="#1D1D1D";class Game{#n;#a;#r;#s;#i;#l;#c;#d;#h;#m;#g;mouseX;mouseY;mouseGridRow;mouseGridCol;constructor(){this.newGame()}newGame(){this.#n=5,this.#a=13,this.#r=Array.from({length:this.#n},()=>Array.from({length:this.#a},()=>new Room)),this.#s={row:2,col:0},this.atCoord(this.player).events={enter:"noop",exit:"noop",use:"noop"},this.atCoord(this.player).revealed=!0,this.atCoord(this.player).hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"unknown",enabled:!0},SOUTH_EAST:{status:"unknown",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"blocked",enabled:!0},NORTH_WEST:{status:"blocked",enabled:!0}},this.#i={row:2,col:9},this.atCoord(this.exit).events={enter:"exit",exit:"noop",use:"noop"},this.atCoord(this.exit).revealed=!0,this.atCoord(this.exit).hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"blocked",enabled:!0},SOUTH_EAST:{status:"blocked",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"unknown",enabled:!0},NORTH_WEST:{status:"unknown",enabled:!0}},this.#g={index:0,position:{row:0,col:0},direction:"NORTH",options:[new Room,new Room,new Room]},this.#g.options.forEach(e=>e.revealed=!0),this.#c={steps:40,keys:1,gems:0},this.mouseX=-1,this.mouseY=-1,this.mouseGridRow=-1,this.mouseGridCol=-1,this.#m=0,this.#h="noop",this.setState("move"),this.play()}get rows(){return this.#n}get cols(){return this.#a}get player(){return this.#s}get exit(){return this.#i}movePlayerTo(e,t){this.#s.row=e,this.#s.col=t}movePlayerToCoord(e){this.movePlayerTo(e.row,e.col)}at(e,t){return this.#r[e][t]}atCoord(e){return this.at(e.row,e.col)}placeRoom(e,t,o){this.valid(e,t)&&(this.#r[e][t]=o)}valid(e,t){return 0<=e&&e<this.#n&&0<=t&&t<this.#a}validCoord(e){return this.valid(e.row,e.col)}setState(e){this.#l=e}getState(){return this.#l}#x(e,t,o){this.at(e,t).revealed=o}#S(e,t){this.#x(e,t,!0)}#u(e,t){this.#x(e,t,!1)}isRevealed(e,t){return this.at(e,t).revealed}isRevealedCoord(e){return this.isRevealed(e.row,e.col)}isHidden(e,t){return!this.isRevealed(e,t)}isHiddenCoord(e){return this.isHidden(e.row,e.col)}getResource(e){return this.#c[e]??0}addResource(e,t=1){e in this.#c||(this.#c[e]=0),this.#c[e]+=t}removeResource(e,t=1){e in this.#c&&(this.#c[e]-=t,this.#c[e]<0&&(this.#c[e]=0))}setResource(e,t){this.#c[e]=t}getResources(){return Object.entries(this.#c).map(([e,t])=>({type:e,count:t}))}pause(){this.#d=!1}play(){this.#d=!0}get isRunning(){return this.#d}get draft(){return this.#g}get lastTimeStamp(){return this.#m}set lastTimeStamp(e){this.#m=e}get lastEffect(){return this.#h}set lastEffect(e){this.#h=e}}const gameState=new Game,at=e=>gameState.atCoord(e),add=(e,t)=>({row:e.row+t.row,col:e.col+t.col}),HEX_DIRECTIONS_ODD_Q={NORTH:{row:-1,col:0},NORTH_EAST:{row:0,col:1},SOUTH_EAST:{row:1,col:1},SOUTH:{row:1,col:0},SOUTH_WEST:{row:1,col:-1},NORTH_WEST:{row:0,col:-1}},HEX_DIRECTIONS_EVEN_Q={NORTH:{row:-1,col:0},NORTH_EAST:{row:-1,col:1},SOUTH_EAST:{row:0,col:1},SOUTH:{row:1,col:0},SOUTH_WEST:{row:0,col:-1},NORTH_WEST:{row:-1,col:-1}},tileTowards=(e,t)=>{const o=e.col%2==0?HEX_DIRECTIONS_EVEN_Q[t]:HEX_DIRECTIONS_ODD_Q[t];return add(e,o)},randomRoomPurpose=()=>{const e=Object.values(Effects).reduce((e,t)=>e+t.rarity,0);let t=randomFloat()*e;for(const e of Object.keys(Effects))if(t-=Effects[e].rarity,t<=0)return e;throw new Error},opposite=e=>{if("NORTH"===e)return"SOUTH";if("NORTH_EAST"===e)return"SOUTH_WEST";if("SOUTH_EAST"===e)return"NORTH_WEST";if("SOUTH"===e)return"NORTH";if("SOUTH_WEST"===e)return"NORTH_EAST";if("NORTH_WEST"===e)return"SOUTH_EAST";throw new Error},generateHallway=(e,t,o)=>{const n=tileTowards(e,t);if(gameState.validCoord(n))if(randomFloat()<.4){const e=at(n);gameState.isHiddenCoord(n)?(o.hallways[t].enabled=!0,o.hallways[t].status="unknown"):e.hallways[opposite(t)].enabled?(o.hallways[t].enabled=!0,o.hallways[t].status="open"):(o.hallways[t].enabled=!0,o.hallways[t].status="blocked")}else o.hallways[t].enabled=!1,o.hallways[t].status="blocked";else o.hallways[t].enabled=!1,o.hallways[t].status="blocked"},generateDraftRoom=(e,t)=>{const o=randomRoomPurpose(),n=gameState.draft.options[e];n.events={enter:o,exit:"noop",use:"noop"},"extraKey"===o?n.items.push("keys"):n.items.length=0,DIRECTION_VALUES.forEach(e=>{generateHallway(gameState.draft.position,e,n)}),n.hallways[opposite(t)].enabled=!0,n.hallways[opposite(t)].status="open",n.needsKey="extraKey"!==o&&randomBool()},refreshDrafts=()=>{const e=gameState.draft.direction;gameState.draft.index=0;let t=!0;do{generateDraftRoom(0,e),generateDraftRoom(1,e),generateDraftRoom(2,e),t=0!==gameState.getResource("keys")||-1!==gameState.draft.options.findIndex(e=>!e.needsKey)}while(!t)};let playerAnimationIsPlaying=!1;const updatePlayerPosition=e=>{if(!gameState.isRunning)return;const t=tileTowards(gameState.player,e);if(!gameState.validCoord(t))return;if(gameState.getResource("steps")<=0)return;const o=at(gameState.player).hallways;o[e].enabled&&"blocked"!==o[e].status&&(gameState.isHiddenCoord(t)?(gameState.draft.position=t,gameState.draft.direction=e,gameState.setState("draft"),refreshDrafts()):at(t).hallways[opposite(e)].enabled&&(at(t).enter(),gameState.movePlayerToCoord(t),gameState.removeResource("steps")))},placeRoom=()=>{const e=gameState.draft.options[gameState.draft.index].copy();e.needsKey&&0===gameState.getResource("keys")||(e.needsKey&&(e.needsKey=!1,gameState.removeResource("keys")),gameState.placeRoom(gameState.draft.position.row,gameState.draft.position.col,e),updatePlayerPosition(gameState.draft.direction),gameState.draft.index=0,DIRECTION_VALUES.forEach(t=>{const o=tileTowards(gameState.draft.position,t);if(gameState.validCoord(o)&&gameState.isRevealedCoord(o)){const n=at(o);!e.hallways[t].enabled&&n.hallways[opposite(t)].enabled?n.hallways[opposite(t)].status="blocked":e.hallways[t].enabled&&n.hallways[opposite(t)].enabled&&(n.hallways[opposite(t)].status="open")}}),gameState.setState("move"))},update=e=>{for(const t of animations)t.active&&t.update(e);animations=animations.filter(e=>e.active)},tweenLerp=(e,t,o,n,a={})=>{animations.push(new Tween({from:e,to:t,duration:o,onUpdate:n,...a}))},fadeIn=(e,t,o={})=>{tweenLerp(0,1,e,t,o)},fadeOut=(e,t,o={})=>{tweenLerp(1,0,e,t,o)},pulse=(e,t,o,n,a={})=>{tweenLerp(e,t,o,n,{...a,loop:!0,reverse:!0})},rotateSpin=(e,t,o,n,a=!1,r={})=>{tweenLerp(e,t,o,n,{...r,loop:a})},FontSizeFactors={xs:1,sm:2,md:3,lg:4,xl:5},getFontSizeInPixels=e=>canvas.width/160*FontSizeFactors[e],renderHallway=(e,t,o,n,a)=>{if(!e.enabled)return;const r={open:{factor:1,color:CSS_COLOR_NAMES.Lavender},blocked:{factor:.5,color:CSS_COLOR_NAMES.FireBrick},unknown:{factor:.75,color:"#e6e6e6"}},s=Math.sqrt(3)*n/2,i=r[e.status].factor;context.fillStyle=r[e.status].color,context.lineWidth=getFontSizeInPixels("xs")/10,context.strokeStyle="black";var l,c,d,h,m;l=t,c=o,d=n/5,h=s*i,m=DIRECTION_VALUES.indexOf(a)*Math.PI/3,context.save(),context.translate(l,c),context.rotate(m),context.strokeRect(-d/2,-h,d,h),context.fillRect(-d/2,-h,d,h),context.restore()},renderHexRoom=(e,t,o,n,a=!1)=>{n.revealed?(renderHexagon(e,t,o,{fill:ROOM_COLORS[n.events.enter],...a&&{border:CSS_COLOR_NAMES.Wheat,borderWidth:3}}),DIRECTION_VALUES.forEach(a=>{renderHallway(n.hallways[a],e,t,o,a)}),renderCircle(e,t,o/5,{fill:CSS_COLOR_NAMES.Lavender,border:"black",borderWidth:.5})):DEBUG_MODE&&renderHexagon(e,t,o,void 0,{fill:"#1D1D1D",border:CSS_COLOR_NAMES.Wheat})},drawRefreshArrow=(e,t,o=50)=>{const n=o/2,a=[{startAngle:.4*Math.PI,endAngle:Math.PI,sign:-1},{startAngle:1.4*Math.PI,endAngle:2*Math.PI,sign:1}];for(const r of a){const a=refreshRotation+r.startAngle,s=refreshRotation+r.endAngle;context.beginPath(),context.arc(e,t,o,a,s),context.strokeStyle="white",context.lineWidth=getFontSizeInPixels("xs")/3,context.stroke(),context.save(),context.translate(e,t),context.rotate(refreshRotation),context.beginPath();const i=n/2,l=Math.sqrt(3)/2*n;context.moveTo(r.sign*o-i,0),context.lineTo(r.sign*o+i,0),context.lineTo(r.sign*o,r.sign*l),context.closePath(),context.fillStyle="white",context.fill(),context.restore()}},drawKeyLabel=(e,t,o)=>{const n=getFontSizeInPixels("sm"),a=n/3,r=n/5;context.save(),context.font=`${n}px monospace`;const s=context.measureText(e).width+2*a,i=n+2*r;context.fillStyle="#f0f0f0",context.strokeStyle="#333",context.lineWidth=getFontSizeInPixels("xs")/10,context.fillRect(t-s/2,o-i/2,s,i),context.strokeRect(t-s/2,o-i/2,s,i),context.textBaseline="middle",context.textAlign="center",context.fillStyle="#333",context.lineWidth=getFontSizeInPixels("xs")/10,context.fillText(e,t,o),context.restore()},renderInLayout=(e,t)=>{context.save(),context.translate(e.x,e.y),t(e.width,e.height),context.restore()},renderMovement=(e,t)=>{const o=e/2,n=t/5;context.textAlign="center",context.textBaseline="top",context.fillStyle="white",context.font=`${getFontSizeInPixels("xl")}px Consolas`,context.fillText("Movement",e/2,n);const a=o,r=2.5*n,s=.5*o;renderHexagon(a,r,s,{fill:ROOM_COLORS.exit}),DIRECTION_VALUES.forEach(e=>{renderHallway({enabled:!0,status:"open"},a,r,s,e)}),renderCircle(a,r,s/5,{fill:CSS_COLOR_NAMES.Lavender,border:"black",borderWidth:.5});const i=["D","S","A","Q","W","E"];for(let e=0;e<6;e++){const t=Math.PI/180*(60*e+30),o=a+1.1*s*Math.cos(t),n=r+1.1*s*Math.sin(t);context.textAlign="center",context.textBaseline="middle",drawKeyLabel(i[e],o,n)}},renderWavyLine=(e,t,o,n,a,r)=>{const s=o-e,i=n-t,l=Math.hypot(s,i),c=Math.atan2(i,s);context.save(),context.translate(e,t),context.rotate(c),context.beginPath(),context.lineWidth=getFontSizeInPixels("xs")/5;for(let e=0;e<=l;e++){const t=e,o=Math.sin(e/l*2*Math.PI*a)*r;0===e?context.moveTo(t,o):context.lineTo(t,o)}context.stroke(),context.restore()},randomSymbolCache=new Map,calculateIfAbsent=(e,t,o)=>{let n=randomSymbolCache.get(e);if(!n){const a=["straight","wavy","dotted","dashed"];n={fillColor:randomElement(Object.values(ROOM_COLORS)),innerSymbol:randomElement(t),outerSymbol:randomElement(o),lineType:randomElement(a)},randomSymbolCache.set(e,n)}return n},renderPuzzle=(e,t,o)=>{const n=o/8,a=o/16;context.lineCap="round";const r=Object.values(SymbolTexts),s=Object.values(AltSymbolTexts),i=`[${gameState.player.row};${gameState.player.col}]`,l=calculateIfAbsent(i,r,s);renderHexagon(e,t,o,{fill:l.fillColor,border:"white",borderWidth:2}),context.setLineDash([n,a]);for(let n=0;n<6;n++){const a=Math.PI/180*(60*n+30),r=e+.6*o*Math.cos(a),s=t+.6*o*Math.sin(a);context.font=`${getFontSizeInPixels("sm")}px monospace`,context.textAlign="center",context.textBaseline="middle",context.fillStyle="white",context.fillText(`${l.outerSymbol}`,r,s)}context.setLineDash([]),context.strokeStyle="white";for(let n=0;n<6;n++){const a=Math.PI/180*(60*n),r=e+1.5*getFontSizeInPixels("xs")*Math.cos(a),s=t+1.5*getFontSizeInPixels("xs")*Math.sin(a),i=e+o*Math.cos(a),c=t+o*Math.sin(a);if("wavy"===l.lineType)renderWavyLine(r,s,i,c,5,getFontSizeInPixels("xs")/2);else{switch(l.lineType){case"straight":context.lineWidth=getFontSizeInPixels("xs")/5,context.setLineDash([]);break;case"dotted":context.setLineDash([o/30]);break;case"dashed":context.setLineDash([o/5])}context.beginPath(),context.moveTo(r,s),context.lineTo(i,c),context.stroke()}}context.setLineDash([]),renderCircle(e,t,getFontSizeInPixels("xs"),{fill:"white"}),context.font=`${getFontSizeInPixels("sm")}px monospace`,context.textAlign="center",context.textBaseline="middle",context.fillText(`${l.innerSymbol}`,e,t)},renderResources=(e,t)=>{context.textAlign="center",context.textBaseline="top",context.fillStyle="white",context.font=`${getFontSizeInPixels("md")}px monospace`,context.fillText("Resources",e/2,0),context.textAlign="left",context.font=`${getFontSizeInPixels("sm")}px monospace`;const o=[];for(const{type:e,count:t}of gameState.getResources())o.push(`• ${ItemTexts[e]} ${e.substring(0,1).toUpperCase()+e.substring(1)}: ${t}`);o.forEach((t,o)=>{context.fillText(t,e/2.5,(o+1)*getFontSizeInPixels("lg"))});const n=e/2;renderPuzzle(n,3*(t/5),.5*n)},renderHexGrid=(e,t)=>{context.strokeStyle="#CECECE",context.lineWidth=getFontSizeInPixels("xs")/5;const o=gameState.cols,n=gameState.rows,a=e/10/2;for(let e=0;e<n;e++)for(let t=0;t<o;t++){const o=Math.sqrt(3)*a,n=(1.5*t+1)*a,r=e*o+(t%2+1)*(o/2);renderHexRoom(n,r,a,gameState.at(e,t)),e===gameState.player.row&&t===gameState.player.col&&renderCircle(n,r,getFontSizeInPixels("xs"),{fill:PLAYER_COLOR}),gameState.mouseGridRow===e&&gameState.mouseGridCol===t&&context.fillText(`[${e};${t}]`,n,r),"draft"===gameState.getState()&&e===gameState.draft.position.row&&t===gameState.draft.position.col&&(context.save(),context.fillStyle=ROOM_COLORS.draft,context.globalAlpha=selectionAlpha,renderHexRoom(n,r,.75*a,gameState.draft.options[gameState.draft.index]),context.restore())}};let selectionAlpha=1,refreshRotation=0;const mouseToGrid=(e,t,o)=>{const n=gameState.rows,a=gameState.cols,r=Math.sqrt(3)*o,s=r/2,i=Math.floor((e-o)/(1.5*o)),l=(i%2+1)*s,c=Math.floor((t-l)/r+.5);return{row:Math.max(0,Math.min(n-1,c)),col:Math.max(0,Math.min(a-1,i))}},renderHexagon=(e,t,o,n,a=void 0)=>{context.save(),context.beginPath();for(let n=0;n<6;n++){const a=Math.PI/180*(60*n),r=e+o*Math.cos(a),s=t+o*Math.sin(a);0===n?context.moveTo(r,s):context.lineTo(r,s)}context.closePath(),a?useColors(a):n&&useColors(n),context.restore()},renderCircle=(e,t,o,n)=>{context.save(),context.beginPath(),context.arc(e,t,o,0,2*Math.PI),context.closePath(),useColors(n),context.restore()},renderHexDraft=(e,t)=>{if("draft"!==gameState.getState())return;const o=e/16,n=t/2;for(let e=0;e<gameState.draft.options.length;++e){const t=3*e+4.5,a=gameState.draft.options[e],r=t*o,s=n,i=.5*o;if(renderHexRoom(r,s,i,a,!0),e===gameState.draft.index){if("noop"!==Effects[a.events.enter].description){const e=1.75*n;context.textAlign="center",context.textBaseline="middle",context.fillStyle="white",context.font=`${getFontSizeInPixels("sm")}px monospace`,context.fillText(Effects[a.events.enter].description,r,e)}if(a.needsKey){const e=(t-1.25)*o,a=n;context.font=`${getFontSizeInPixels("lg")}px monospace`,context.textAlign="center",context.textBaseline="middle",context.fillText(ItemTexts.lock,e,a)}if(a.items.includes("keys")){const e=(t+1.25)*o,a=n;context.font=`${getFontSizeInPixels("lg")}px monospace`,context.textAlign="center",context.textBaseline="middle",context.fillText(ItemTexts.keys,e,a)}const e=a.needsKey&&0===gameState.getResource("keys");context.save(),context.globalAlpha=selectionAlpha,renderHexagon(r,s,1.2*i,{border:e?"red":"yellow",borderWidth:6}),context.restore()}}if(gameState.getResource("gems")>=2){drawRefreshArrow(14.5*o,n,n/3),context.textAlign="center",context.textBaseline="middle",context.fillStyle="white",context.font=`${getFontSizeInPixels("sm")}px monospace`,context.fillText(`2×${ItemTexts.gems}`,14.5*o,n),context.fillText("[R]",14.5*o,2*n)}},renderHints=(e,t)=>{context.textAlign="center",context.textBaseline="top",context.fillStyle="white",context.font=`${getFontSizeInPixels("sm")}px monospace`;const o=["Draft rooms by selecting an option and press [Space] or [Enter].","Some rooms are locked behind a key, so look out for them to help on your journey!","Different rooms can help or hinder you. Gems help you refresh your draft options. Spend them wisely!","Red paths are blocked from the other side. Gray ones are yet unvisited, while whites are already known.","Do not be afraid to explore for additional resources!"];o.length;o.forEach((t,o)=>{context.fillText(t,e/2,o*getFontSizeInPixels("lg")+getFontSizeInPixels("xs"))})},getPlayArea=()=>{const e=16/9,t=canvas.width,o=canvas.height;if(t/o>e){const n=o*e;return{x:(t-n)/2,y:0,width:n,height:o}}{const n=t/e;return{x:0,y:(o-n)/2,width:t,height:n}}},render=()=>{canvas.width=window.innerWidth,canvas.height=window.innerHeight,context.fillStyle="#1D1D1D",context.fillRect(0,0,canvas.width,canvas.height);const{x:e,y:t,width:o,height:n}=getPlayArea(),a=o/16,r=n/9,s={draft:{x:e,y:t,width:o,height:2*r},grid:{x:e+3*a,y:t+2*r,width:10*a,height:5*r},resources:{x:e,y:t+2*r,width:3*a,height:5*r},movement:{x:e+13*a,y:t+2*r,width:3*a,height:5*r},footer:{x:e,y:t+7*r,width:o,height:2*r}},i=gameState.rows,l=gameState.cols,c=Math.min(128,Math.floor(Math.min(canvas.width/l,canvas.height/i))),d=Math.floor((canvas.width-c*l)/2),h=Math.floor((canvas.height-c*i)/2);if(renderInLayout(s.draft,renderHexDraft),renderInLayout(s.resources,renderResources),renderInLayout(s.grid,renderHexGrid),renderInLayout(s.movement,renderMovement),renderInLayout(s.footer,renderHints),DEBUG_MODE){context.strokeStyle=CSS_COLOR_NAMES.Pink,context.lineWidth=getFontSizeInPixels("xs")/5;for(const[e,t]of Object.entries(s))context.strokeRect(t.x,t.y,t.width,t.height),context.textAlign="left",context.textBaseline="top",context.fillStyle=CSS_COLOR_NAMES.Pink,context.font=`${getFontSizeInPixels("sm")}px monospace`,context.fillText(`[${e}]`,t.x+5,t.y+5)}return"noop"!==gameState.lastEffect&&(context.textAlign="right",context.textBaseline="middle",context.fillStyle="white",context.font=`${getFontSizeInPixels("sm")}px monospace`,context.fillText(`${gameState.lastEffect}`,d+l*c-c/2,h-c/2)),!0},handleMove=e=>{gameState.mouseX=e.offsetX,gameState.mouseY=e.offsetY},handleClick=e=>{"move"===gameState.getState()&&(gameState.valid(gameState.mouseGridRow,gameState.mouseGridCol)?console.log(`Move [${gameState.mouseGridRow};${gameState.mouseGridCol}]`):console.log(`Cannot move to [${gameState.mouseGridRow};${gameState.mouseGridCol}]`))},globalShortcuts={r:()=>gameState.newGame(),h:()=>{DEBUG_MODE=!DEBUG_MODE,canvas.style.cursor=DEBUG_MODE?"pointer":"default"},g:()=>gameState.addResource("gems",5),k:()=>gameState.addResource("keys",5)},moveControls={w:()=>updatePlayerPosition("NORTH"),ArrowUp:()=>updatePlayerPosition("NORTH"),e:()=>updatePlayerPosition("NORTH_EAST"),d:()=>updatePlayerPosition("SOUTH_EAST"),s:()=>updatePlayerPosition("SOUTH"),ArrowDown:()=>updatePlayerPosition("SOUTH"),a:()=>updatePlayerPosition("SOUTH_WEST"),q:()=>updatePlayerPosition("NORTH_WEST")},draftControls={d:()=>gameState.draft.index=clamp(gameState.draft.index+1,0,gameState.draft.options.length-1),ArrowRight:()=>gameState.draft.index=clamp(gameState.draft.index+1,0,gameState.draft.options.length-1),a:()=>gameState.draft.index=clamp(gameState.draft.index-1,0,gameState.draft.options.length-1),ArrowLeft:()=>gameState.draft.index=clamp(gameState.draft.index-1,0,gameState.draft.options.length-1)," ":()=>placeRoom(),Enter:()=>placeRoom(),r:()=>{gameState.getResource("gems")>=2&&(gameState.removeResource("gems",2),refreshDrafts())}},handleInput=e=>{const t=e.key,o=gameState.getState();globalShortcuts[t]?globalShortcuts[t]():"move"===o&&moveControls[t]?moveControls[t]():"draft"===o&&draftControls[t]&&draftControls[t]()};let lastFrameTime=performance.now();const gameLoop=e=>{const t=1e3/(e-lastFrameTime);lastFrameTime=e,gameState.lastTimeStamp=e,update(e),render()?(context.textAlign="left",context.textBaseline="middle",context.fillStyle=CSS_COLOR_NAMES.Pink,context.font=`${getFontSizeInPixels("sm")}px monospace`,context.fillText(`FPS: ${Math.round(t)}`,50,50)):(context.textAlign="center",context.textBaseline="middle",context.fillStyle=CSS_COLOR_NAMES.Red,context.font=`${getFontSizeInPixels("sm")}px monospace`,context.fillText("Play area not suitable for this game, buy a proper display.",canvas.width/2,canvas.height/2)),requestAnimationFrame(gameLoop)},run=async()=>{document.addEventListener("keydown",handleInput),gameLoop(0)};run().then(()=>console.log("Game started."));