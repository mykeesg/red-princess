let e=!1,t=!0;const o=["NORTH","NORTH_EAST","SOUTH_EAST","SOUTH","SOUTH_WEST","NORTH_WEST"],s={steps:"👣",keys:"🔑",lock:"🔒",gems:"💎"},r={spiral:"🌀",diamond:"🔶",loop:"➰",bright:"🔆",circle:"🔴",square:"🟩"},i={target:"🎯",star:"✴️",slash:"〰️",paint:"🎨",egg:"🥚",grid:"🔳"},n=e=>`[${e.row};${e.col}]`,a=(e,t)=>e.row===t.row&&e.col===t.col;const l=new class{#e;constructor(e=0){this.setSeed(e)}setSeed(e){this.#e=e??Math.floor(Math.random()*Math.pow(2,31))+1}float(){return this.#e^=this.#e<<13,this.#e^=this.#e>>17,this.#e^=this.#e<<5,(this.#e>>>0)/4294967295}int32(){return this.#e^=this.#e<<13,this.#e^=this.#e>>17,this.#e^=this.#e<<5,0|this.#e}get seed(){return this.#e}}(Date.now()),d=()=>l.float(),h=(e=0)=>{return e?(t=0,o=e,Math.floor(d()*(o-t))+t):l.int32();var t,o},c=e=>e[h(e.length)],u={extraSteps:{invoke:()=>k.addResource("steps",2),description:"Take a rest.",triggerText:"You have gained 2 extra steps.",triggerLimit:-1,rarity:.5},extraKey:{invoke:()=>k.addResource("keys"),description:"Alohomora.",triggerText:"You have found a key.",triggerLimit:1,rarity:.3},money:{invoke:()=>k.addResource("gems"),description:"What's that spark in the corner?",triggerText:"You have found a gem.",triggerLimit:1,rarity:.3},taxes:{invoke:()=>k.removeResource("gems"),description:"Takes a toll on you.",triggerText:`You have to pay taxes: ${s.gems}`,triggerLimit:-1,rarity:.3},garden:{invoke:()=>k.setResource("steps",41),description:"Like starting again.",triggerText:"Your steps have been reset.",triggerLimit:-1,rarity:.4},shop:{invoke:()=>{k.getResource("gems")>=5&&(k.addResource("keys"),k.removeResource("gems",5))},description:"Buy your passage.",triggerText:"You can buy a key for #5 with [Space].",triggerLimit:1,rarity:.9},exit:{invoke:()=>{k.pause()},description:"",triggerText:"You have won!",triggerLimit:-1,rarity:0},noop:{invoke:()=>{},description:"A simple room.",triggerText:"",triggerLimit:-1,rarity:.7}};class f{constructor({from:e,to:t,duration:o,ease:s=e=>e,onUpdate:r,onComplete:i,loop:n=!1,reverse:a=!1,type:l=""}){this.from=e,this.to=t,this.duration=o,this.ease=s,this.onUpdate=r,this.onComplete=i,this.loop=n,this.reverse=a,this.active=!0,this.startTime=performance.now(),this.type=l}update(e){const t=Math.min((e-this.startTime)/this.duration,1),o=this.ease(t),s=this.from+(this.to-this.from)*o;this.onUpdate(s),1===t&&(this.loop?(this.reverse&&([this.from,this.to]=[this.to,this.from]),this.startTime=e):(this.active=!1,this.onComplete?.()))}}let g=[new f({from:.1,to:1,duration:800,loop:!0,reverse:!0,onUpdate:e=>Y=e,type:"selection-pulse"}),new f({from:0,to:2*Math.PI,duration:2e3,loop:!0,onUpdate:e=>j=e,type:"refresh-rotate"})];class y{events;hallways;revealed;triggerCount;needsKey;items;constructor(e=void 0){e?(this.events=e.events,this.hallways=e.hallways,this.revealed=e.revealed,this.triggerCount=e.triggerCount,this.needsKey=e.needsKey,this.items=e.items):this.#t()}#t(){this.events={enter:"noop",exit:"noop",use:"noop"},this.hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"unknown",enabled:!0},SOUTH_EAST:{status:"unknown",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"unknown",enabled:!0},NORTH_WEST:{status:"unknown",enabled:!0}},this.revealed=!1,this.triggerCount=0,this.needsKey=!1,this.items=[]}#o(e){-1===u[e].triggerLimit?(u[e].invoke(),k.lastEffect=u[e].triggerText):this.triggerCount<u[e].triggerLimit?(u[e].invoke(),k.lastEffect=u[e].triggerText,this.triggerCount+=1):k.lastEffect=""}enter(){this.#o(this.events.enter)}use(){this.#o(this.events.use)}exit(){this.#o(this.events.exit)}copy(){return new y(JSON.parse(JSON.stringify(this)))}}const m=document.querySelector("#canvas"),p=m.getContext("2d"),F={AliceBlue:"#F0F8FF",AntiqueWhite:"#FAEBD7",Aqua:"#00FFFF",Aquamarine:"#7FFFD4",Azure:"#F0FFFF",Beige:"#F5F5DC",Bisque:"#FFE4C4",Black:"#000000",BlanchedAlmond:"#FFEBCD",Blue:"#0000FF",BlueViolet:"#8A2BE2",Brown:"#A52A2A",BurlyWood:"#DEB887",CadetBlue:"#5F9EA0",Chartreuse:"#7FFF00",Chocolate:"#D2691E",Coral:"#FF7F50",CornflowerBlue:"#6495ED",Cornsilk:"#FFF8DC",Crimson:"#DC143C",Cyan:"#00FFFF",DarkBlue:"#00008B",DarkCyan:"#008B8B",DarkGoldenRod:"#B8860B",DarkGray:"#A9A9A9",DarkGrey:"#A9A9A9",DarkGreen:"#006400",DarkKhaki:"#BDB76B",DarkMagenta:"#8B008B",DarkOliveGreen:"#556B2F",DarkOrange:"#FF8C00",DarkOrchid:"#9932CC",DarkRed:"#8B0000",DarkSalmon:"#E9967A",DarkSeaGreen:"#8FBC8F",DarkSlateBlue:"#483D8B",DarkSlateGray:"#2F4F4F",DarkSlateGrey:"#2F4F4F",DarkTurquoise:"#00CED1",DarkViolet:"#9400D3",DeepPink:"#FF1493",DeepSkyBlue:"#00BFFF",DimGray:"#696969",DimGrey:"#696969",DodgerBlue:"#1E90FF",FireBrick:"#B22222",FloralWhite:"#FFFAF0",ForestGreen:"#228B22",Fuchsia:"#FF00FF",Gainsboro:"#DCDCDC",GhostWhite:"#F8F8FF",Gold:"#FFD700",GoldenRod:"#DAA520",Gray:"#808080",Grey:"#808080",Green:"#008000",GreenYellow:"#ADFF2F",HoneyDew:"#F0FFF0",HotPink:"#FF69B4",IndianRed:"#CD5C5C",Indigo:"#4B0082",Ivory:"#FFFFF0",Khaki:"#F0E68C",Lavender:"#E6E6FA",LavenderBlush:"#FFF0F5",LawnGreen:"#7CFC00",LemonChiffon:"#FFFACD",LightBlue:"#ADD8E6",LightCoral:"#F08080",LightCyan:"#E0FFFF",LightGoldenRodYellow:"#FAFAD2",LightGray:"#D3D3D3",LightGrey:"#D3D3D3",LightGreen:"#90EE90",LightPink:"#FFB6C1",LightSalmon:"#FFA07A",LightSeaGreen:"#20B2AA",LightSkyBlue:"#87CEFA",LightSlateGray:"#778899",LightSlateGrey:"#778899",LightSteelBlue:"#B0C4DE",LightYellow:"#FFFFE0",Lime:"#00FF00",LimeGreen:"#32CD32",Linen:"#FAF0E6",Magenta:"#FF00FF",Maroon:"#800000",MediumAquaMarine:"#66CDAA",MediumBlue:"#0000CD",MediumOrchid:"#BA55D3",MediumPurple:"#9370DB",MediumSeaGreen:"#3CB371",MediumSlateBlue:"#7B68EE",MediumSpringGreen:"#00FA9A",MediumTurquoise:"#48D1CC",MediumVioletRed:"#C71585",MidnightBlue:"#191970",MintCream:"#F5FFFA",MistyRose:"#FFE4E1",Moccasin:"#FFE4B5",NavajoWhite:"#FFDEAD",Navy:"#000080",OldLace:"#FDF5E6",Olive:"#808000",OliveDrab:"#6B8E23",Orange:"#FFA500",OrangeRed:"#FF4500",Orchid:"#DA70D6",PaleGoldenRod:"#EEE8AA",PaleGreen:"#98FB98",PaleTurquoise:"#AFEEEE",PaleVioletRed:"#DB7093",PapayaWhip:"#FFEFD5",PeachPuff:"#FFDAB9",Peru:"#CD853F",Pink:"#FFC0CB",Plum:"#DDA0DD",PowderBlue:"#B0E0E6",Purple:"#800080",RebeccaPurple:"#663399",Red:"#FF0000",RosyBrown:"#BC8F8F",RoyalBlue:"#4169E1",SaddleBrown:"#8B4513",Salmon:"#FA8072",SandyBrown:"#F4A460",SeaGreen:"#2E8B57",SeaShell:"#FFF5EE",Sienna:"#A0522D",Silver:"#C0C0C0",SkyBlue:"#87CEEB",SlateBlue:"#6A5ACD",SlateGray:"#708090",SlateGrey:"#708090",Snow:"#FFFAFA",SpringGreen:"#00FF7F",SteelBlue:"#4682B4",Tan:"#D2B48C",Teal:"#008080",Thistle:"#D8BFD8",Tomato:"#FF6347",Turquoise:"#40E0D0",Violet:"#EE82EE",Wheat:"#F5DEB3",White:"#FFFFFF",WhiteSmoke:"#F5F5F5",Yellow:"#FFFF00",YellowGreen:"#9ACD32"},w=e=>{e.fill&&(p.fillStyle=e.fill,p.fill()),e.border&&(p.strokeStyle=e.border,p.lineWidth=e.borderWidth??G("xs")/10,p.stroke())},T=(e,t,o)=>e<t?t:e>o?o:e,S={noop:"#AF6C31",taxes:"#AE0000",garden:"#2F8043",shop:"#D7DE87",extraSteps:"#6E5381",money:F.Tan,extraKey:F.Gold,exit:"#005A8D",draft:F.LightSteelBlue},x=F.Black,v="#1D1D1D";const k=new class{#s;#r;#i;#n;#a;#l;#d;#h;#c;#u;#f;mouseGridRow;mouseGridCol;constructor(){this.newGame()}newGame(){this.#s=5,this.#r=13,this.#i=Array.from({length:this.#s},()=>Array.from({length:this.#r},()=>new y)),this.#n={row:2,col:0},this.atCoord(this.player).events={enter:"noop",exit:"noop",use:"noop"},this.atCoord(this.player).revealed=!0,this.atCoord(this.player).hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"unknown",enabled:!0},SOUTH_EAST:{status:"unknown",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"blocked",enabled:!0},NORTH_WEST:{status:"blocked",enabled:!0}},this.#a={row:2,col:9},this.atCoord(this.exit).events={enter:"exit",exit:"noop",use:"noop"},this.atCoord(this.exit).revealed=!0,this.atCoord(this.exit).hallways={NORTH:{status:"unknown",enabled:!0},NORTH_EAST:{status:"blocked",enabled:!0},SOUTH_EAST:{status:"blocked",enabled:!0},SOUTH:{status:"unknown",enabled:!0},SOUTH_WEST:{status:"unknown",enabled:!0},NORTH_WEST:{status:"unknown",enabled:!0}},this.#f={index:0,position:{row:0,col:0},direction:"NORTH",options:[new y,new y,new y]},this.#f.options.forEach(e=>e.revealed=!0),this.#d={steps:40,keys:1,gems:0},this.mouseGridRow=-1,this.mouseGridCol=-1,this.#u=0,this.#c="noop",this.setState("move"),this.play()}get rows(){return this.#s}get cols(){return this.#r}get player(){return this.#n}get exit(){return this.#a}movePlayerTo(e,t){this.#n.row=e,this.#n.col=t}movePlayerToCoord(e){this.movePlayerTo(e.row,e.col)}at(e,t){return this.#i[e][t]}atCoord(e){return this.at(e.row,e.col)}placeRoom(e,t,o){this.valid(e,t)&&(this.#i[e][t]=o)}valid(e,t){return 0<=e&&e<this.#s&&0<=t&&t<this.#r}validCoord(e){return this.valid(e.row,e.col)}setState(e){this.#l=e}getState(){return this.#l}#g(e,t,o){this.at(e,t).revealed=o}#y(e,t){this.#g(e,t,!0)}#m(e,t){this.#g(e,t,!1)}isRevealed(e,t){return this.at(e,t).revealed}isRevealedCoord(e){return this.isRevealed(e.row,e.col)}isHidden(e,t){return!this.isRevealed(e,t)}isHiddenCoord(e){return this.isHidden(e.row,e.col)}getResource(e){return this.#d[e]??0}addResource(e,t=1){e in this.#d||(this.#d[e]=0),this.#d[e]+=t}removeResource(e,t=1){e in this.#d&&(this.#d[e]-=t,this.#d[e]<0&&(this.#d[e]=0))}setResource(e,t){this.#d[e]=t}getResources(){return Object.entries(this.#d).map(([e,t])=>({type:e,count:t}))}pause(){this.#h=!1}play(){this.#h=!0}get isRunning(){return this.#h}get draft(){return this.#f}get lastTimeStamp(){return this.#u}set lastTimeStamp(e){this.#u=e}get lastEffect(){return this.#c}set lastEffect(e){this.#c=e}},E=e=>k.atCoord(e),A={NORTH:{row:-1,col:0},NORTH_EAST:{row:0,col:1},SOUTH_EAST:{row:1,col:1},SOUTH:{row:1,col:0},SOUTH_WEST:{row:1,col:-1},NORTH_WEST:{row:0,col:-1}},D={NORTH:{row:-1,col:0},NORTH_EAST:{row:-1,col:1},SOUTH_EAST:{row:0,col:1},SOUTH:{row:1,col:0},SOUTH_WEST:{row:0,col:-1},NORTH_WEST:{row:-1,col:-1}},C=(e,t)=>{const o=e.col%2==0?D[t]:A[t];return r=o,{row:(s=e).row+r.row,col:s.col+r.col};var s,r},B=e=>{if("NORTH"===e)return"SOUTH";if("NORTH_EAST"===e)return"SOUTH_WEST";if("SOUTH_EAST"===e)return"NORTH_WEST";if("SOUTH"===e)return"NORTH";if("SOUTH_WEST"===e)return"NORTH_EAST";if("NORTH_WEST"===e)return"SOUTH_EAST";throw new Error},R=(e,t)=>{const s=(()=>{const e=Object.values(u).reduce((e,t)=>e+t.rarity,0);let t=d()*e;for(const e of Object.keys(u))if(t-=u[e].rarity,t<=0)return e;throw new Error})(),r=k.draft.options[e];r.events={enter:s,exit:"noop",use:"noop"},"extraKey"===s?r.items.push("keys"):r.items.length=0,o.forEach(e=>{((e,t,o)=>{const s=C(e,t);if(k.validCoord(s))if(d()<.4){const e=E(s);k.isHiddenCoord(s)?(o.hallways[t].enabled=!0,o.hallways[t].status="unknown"):e.hallways[B(t)].enabled?(o.hallways[t].enabled=!0,o.hallways[t].status="open"):(o.hallways[t].enabled=!0,o.hallways[t].status="blocked")}else o.hallways[t].enabled=!1,o.hallways[t].status="blocked";else o.hallways[t].enabled=!1,o.hallways[t].status="blocked"})(k.draft.position,e,r)}),r.hallways[B(t)].enabled=!0,r.hallways[B(t)].status="open",r.needsKey="extraKey"!==s&&h()%2==0},b=()=>{const e=k.draft.direction;k.draft.index=0;let t=!0;do{R(0,e),R(1,e),R(2,e),t=0!==k.getResource("keys")||-1!==k.draft.options.findIndex(e=>!e.needsKey)}while(!t)};const O=e=>{if(!k.isRunning)return;const t=C(k.player,e);if(!k.validCoord(t))return;if(k.getResource("steps")<=0)return;const o=E(k.player).hallways;o[e].enabled&&"blocked"!==o[e].status&&(k.isHiddenCoord(t)?(k.draft.position=t,k.draft.direction=e,k.setState("draft"),b()):E(t).hallways[B(e)].enabled&&(E(t).enter(),k.movePlayerToCoord(t),k.removeResource("steps")))},H=()=>{const e=k.draft.options[k.draft.index].copy();e.needsKey&&0===k.getResource("keys")||(e.needsKey&&(e.needsKey=!1,k.removeResource("keys")),k.placeRoom(k.draft.position.row,k.draft.position.col,e),O(k.draft.direction),k.draft.index=0,o.forEach(t=>{const o=C(k.draft.position,t);if(k.validCoord(o)&&k.isRevealedCoord(o)){const s=E(o);!e.hallways[t].enabled&&s.hallways[B(t)].enabled?s.hallways[B(t)].status="blocked":e.hallways[t].enabled&&s.hallways[B(t)].enabled&&(s.hallways[B(t)].status="open")}}),k.setState("move"))};const M={xs:1,sm:2,md:3,lg:4,xl:5},G=e=>m.width/160*M[e],P=(e,t,s,r,i)=>{if(!e.enabled)return;const n={open:{factor:1,color:F.Lavender},blocked:{factor:.5,color:F.FireBrick},unknown:{factor:.75,color:"#e6e6e6"}},a=Math.sqrt(3)*r/2,l=n[e.status].factor;p.fillStyle=n[e.status].color,p.lineWidth=G("xs")/10,p.strokeStyle="black";var d,h,c,u,f;d=t,h=s,c=r/5,u=a*l,f=o.indexOf(i)*Math.PI/3,p.save(),p.translate(d,h),p.rotate(f),p.strokeRect(-c/2,-u,c,u),p.fillRect(-c/2,-u,c,u),p.restore()},W=(t,s,r,i,n=!1)=>{i.revealed?(V(t,s,r,{fill:S[i.events.enter],...n&&{border:F.Wheat,borderWidth:3}}),o.forEach(e=>{P(i.hallways[e],t,s,r,e)}),J(t,s,r/5,{fill:F.Lavender,border:"black",borderWidth:.5})):e&&V(t,s,r,void 0,{fill:v,border:F.Wheat})},L=(e,t,o)=>{const s=G("sm"),r=s/3,i=s/5;p.save(),p.font=`${s}px monospace`;const n=p.measureText(e).width+2*r,a=s+2*i;p.fillStyle="#f0f0f0",p.strokeStyle="#333",p.lineWidth=G("xs")/10,p.fillRect(t-n/2,o-a/2,n,a),p.strokeRect(t-n/2,o-a/2,n,a),p.textBaseline="middle",p.textAlign="center",p.fillStyle="#333",p.lineWidth=G("xs")/10,p.fillText(e,t,o),p.restore()},_=(e,t)=>{p.save(),p.translate(e.x,e.y),t(e.width,e.height),p.restore()},U=(e,t)=>{const s=e/2,r=t/5;p.textAlign="center",p.textBaseline="top",p.fillStyle="white",p.font=`${G("xl")}px Consolas`,p.fillText("Movement",e/2,r);const i=s,n=2.5*r,a=.5*s;V(i,n,a,{fill:S.exit}),o.forEach(e=>{P({enabled:!0,status:"open"},i,n,a,e)}),J(i,n,a/5,{fill:F.Lavender,border:"black",borderWidth:.5});const l=["D","S","A","Q","W","E"];for(let e=0;e<6;e++){const t=Math.PI/180*(60*e+30),o=i+1.1*a*Math.cos(t),s=n+1.1*a*Math.sin(t);p.textAlign="center",p.textBaseline="middle",L(l[e],o,s)}},N=(e,t,o,s,r,i)=>{const n=o-e,a=s-t,l=Math.hypot(n,a),d=Math.atan2(a,n);p.save(),p.translate(e,t),p.rotate(d),p.beginPath(),p.lineWidth=G("xs")/5;for(let e=0;e<=l;e++){const t=e,o=Math.sin(e/l*2*Math.PI*r)*i;0===e?p.moveTo(t,o):p.lineTo(t,o)}p.stroke(),p.restore()},$=new Map,I=(e,t,o)=>{const s=o/8,a=o/16;p.lineCap="round";const l=Object.values(r),d=Object.values(i),h=((e,t,o)=>{let s=$.get(e);if(!s){const r=["straight","wavy","dotted","dashed"];s={fillColor:c(Object.values(S)),innerSymbol:c(t),outerSymbol:c(o),lineType:c(r)},$.set(e,s)}return s})(n(k.player),l,d);V(e,t,o,{fill:h.fillColor,border:"white",borderWidth:2}),p.setLineDash([s,a]);for(let s=0;s<6;s++){const r=Math.PI/180*(60*s+30),i=e+.6*o*Math.cos(r),n=t+.6*o*Math.sin(r);p.font=`${G("sm")}px monospace`,p.textAlign="center",p.textBaseline="middle",p.fillStyle="white",p.fillText(`${h.outerSymbol}`,i,n)}p.setLineDash([]),p.strokeStyle="white";for(let s=0;s<6;s++){const r=Math.PI/180*(60*s),i=e+1.5*G("xs")*Math.cos(r),n=t+1.5*G("xs")*Math.sin(r),a=e+o*Math.cos(r),l=t+o*Math.sin(r);if("wavy"===h.lineType)N(i,n,a,l,5,G("xs")/2);else{switch(h.lineType){case"straight":p.lineWidth=G("xs")/5,p.setLineDash([]);break;case"dotted":p.setLineDash([o/30]);break;case"dashed":p.setLineDash([o/5])}p.beginPath(),p.moveTo(i,n),p.lineTo(a,l),p.stroke()}}p.setLineDash([]),J(e,t,G("xs"),{fill:"white"}),p.font=`${G("sm")}px monospace`,p.textAlign="center",p.textBaseline="middle",p.fillText(`${h.innerSymbol}`,e,t)},q=(e,t)=>{p.textAlign="center",p.textBaseline="top",p.fillStyle="white",p.font=`${G("md")}px monospace`,p.fillText("Resources",e/2,0),p.textAlign="left",p.font=`${G("sm")}px monospace`;const o=[];for(const{type:e,count:t}of k.getResources())o.push(`• ${s[e]} ${e.substring(0,1).toUpperCase()+e.substring(1)}: ${t}`);o.forEach((t,o)=>{p.fillText(t,e/2.5,(o+1)*G("lg"))});const r=e/2;I(r,3*(t/5),.5*r)},K=(t,s)=>{p.strokeStyle="#CECECE",p.lineWidth=G("xs")/5;const r=k.cols,i=k.rows,n=t/10/2;for(let t=0;t<i;t++)for(let s=0;s<r;s++){const r=Math.sqrt(3)*n,i=(1.5*s+1)*n,l=t*r+(s%2+1)*(r/2);W(i,l,n,k.at(t,s)),t===k.player.row&&s===k.player.col&&J(i,l,G("xs"),{fill:x}),k.mouseGridRow===t&&k.mouseGridCol===s&&(e&&(p.fillStyle="white",p.textBaseline="middle",p.textAlign="center",p.fillText(`[${t};${s}]`,i,l)),"move"===k.getState()&&o.some(e=>a(C(k.player,e),{row:t,col:s}))&&V(i,l,.75*n,{fill:S.draft})),"draft"===k.getState()&&t===k.draft.position.row&&s===k.draft.position.col&&(p.save(),p.fillStyle=S.draft,p.globalAlpha=Y,W(i,l,.75*n,k.draft.options[k.draft.index]),p.restore())}};let Y=1,j=0;const V=(e,t,o,s,r=void 0)=>{p.save(),p.beginPath();for(let s=0;s<6;s++){const r=Math.PI/180*(60*s),i=e+o*Math.cos(r),n=t+o*Math.sin(r);0===s?p.moveTo(i,n):p.lineTo(i,n)}p.closePath(),r?w(r):s&&w(s),p.restore()},J=(e,t,o,s)=>{p.save(),p.beginPath(),p.arc(e,t,o,0,2*Math.PI),p.closePath(),w(s),p.restore()},z=(e,t)=>{if("draft"!==k.getState())return;const o=e/16,r=t/2;for(let e=0;e<k.draft.options.length;++e){const t=3*e+4.5,i=k.draft.options[e],n=t*o,a=r,l=.5*o;if(W(n,a,l,i,!0),e===k.draft.index){if("noop"!==u[i.events.enter].description){const e=1.75*r;p.textAlign="center",p.textBaseline="middle",p.fillStyle="white",p.font=`${G("sm")}px monospace`,p.fillText(u[i.events.enter].description,n,e)}if(i.needsKey){const e=(t-1.25)*o,i=r;p.font=`${G("lg")}px monospace`,p.textAlign="center",p.textBaseline="middle",p.fillText(s.lock,e,i)}if(i.items.includes("keys")){const e=(t+1.25)*o,i=r;p.font=`${G("lg")}px monospace`,p.textAlign="center",p.textBaseline="middle",p.fillText(s.keys,e,i)}const e=i.needsKey&&0===k.getResource("keys");p.save(),p.globalAlpha=Y,V(n,a,1.2*l,{border:e?"red":"yellow",borderWidth:6}),p.restore()}}if(k.getResource("gems")>=2){((e,t,o=50)=>{const s=o/2,r=[{startAngle:.4*Math.PI,endAngle:Math.PI,sign:-1},{startAngle:1.4*Math.PI,endAngle:2*Math.PI,sign:1}];for(const i of r){const r=j+i.startAngle,n=j+i.endAngle;p.beginPath(),p.arc(e,t,o,r,n),p.strokeStyle="white",p.lineWidth=G("xs")/3,p.stroke(),p.save(),p.translate(e,t),p.rotate(j),p.beginPath();const a=s/2,l=Math.sqrt(3)/2*s;p.moveTo(i.sign*o-a,0),p.lineTo(i.sign*o+a,0),p.lineTo(i.sign*o,i.sign*l),p.closePath(),p.fillStyle="white",p.fill(),p.restore()}})(14.5*o,r,r/3),p.textAlign="center",p.textBaseline="middle",p.fillStyle="white",p.font=`${G("sm")}px monospace`,p.fillText(`2×${s.gems}`,14.5*o,r),p.fillText("[R]",14.5*o,2*r)}},Q=(e,t)=>{p.textAlign="center",p.textBaseline="top",p.fillStyle="white",p.font=`${G("sm")}px monospace`;const o=["Draft rooms by selecting an option and press [Space] or [Enter].","Some rooms are locked behind a key, so look out for them to help on your journey!","Different rooms can help or hinder you. Gems help you refresh your draft options. Spend them wisely!","Red paths are blocked from the other side. Gray ones are yet unvisited, while whites are already known.","Do not be afraid to explore for additional resources!"];o.length;o.forEach((t,o)=>{p.fillText(t,e/2,o*G("lg")+G("xs"))})},X=new Map,Z=()=>{m.width=window.innerWidth,m.height=window.innerHeight,p.fillStyle=v,p.fillRect(0,0,m.width,m.height);const{x:o,y:s,width:r,height:i}=(()=>{const e=16/9,t=m.width,o=m.height;if(t/o>e){const s=o*e;return{x:(t-s)/2,y:0,width:s,height:o}}{const s=t/e;return{x:0,y:(o-s)/2,width:t,height:s}}})(),a=r/16,l=i/9,d={draft:{x:o,y:s,width:r,height:2*l},grid:{x:o+3*a,y:s+2*l,width:10*a,height:5*l},resources:{x:o,y:s+2*l,width:3*a,height:5*l},movement:{x:o+13*a,y:s+2*l,width:3*a,height:5*l},footer:{x:o,y:s+7*l,width:r,height:2*l}};ee.layout=d,ee.unitWidth=a,ee.unitHeight=l;const h=k.rows,c=k.cols,u=Math.min(128,Math.floor(Math.min(m.width/c,m.height/h))),f=Math.floor((m.width-u*c)/2),g=Math.floor((m.height-u*h)/2);if(_(d.draft,z),_(d.resources,q),_(d.grid,K),_(d.movement,U),_(d.footer,Q),e){p.strokeStyle=F.Pink,p.lineWidth=G("xs")/5;for(const[e,t]of Object.entries(d))p.strokeRect(t.x,t.y,t.width,t.height),p.textAlign="left",p.textBaseline="top",p.fillStyle=F.Pink,p.font=`${G("sm")}px monospace`,p.fillText(`[${e}]`,t.x+5,t.y+5)}if("noop"!==k.lastEffect&&(p.textAlign="right",p.textBaseline="middle",p.fillStyle="white",p.font=`${G("sm")}px monospace`,p.fillText(`${k.lastEffect}`,f+c*u-u/2,g-u/2)),t){const e=a/2;for(let t=0;t<h;t++)for(let o=0;o<c;o++){const s=Math.sqrt(3)*e,r=(1.5*o+1)*e,i=t*s+(o%2+1)*(s/2),a=new Path2D;for(let t=0;t<6;t++){const o=Math.PI/180*(60*t),s=r+e*Math.cos(o),n=i+e*Math.sin(o);0===t?a.moveTo(s,n):a.lineTo(s,n)}a.closePath(),X.set(n({row:t,col:o}),a)}}return t=!1,!0},ee=new class{layout;mousePosition;unitWidth;unitHeight;constructor(){this.mousePosition={x:-1,y:-1}}},te=e=>{const t=((e,t)=>{for(let o=0;o<k.rows;o++)for(let s=0;s<k.cols;s++){const r={row:o,col:s};if(p.isPointInPath(X.get(n(r)),e,t))return r}return{row:-1,col:-1}})(e.offsetX-ee.layout.grid.x,e.offsetY-ee.layout.grid.y,ee.unitWidth);k.mouseGridRow=t.row,k.mouseGridCol=t.col,k.validCoord(t)&&(o.some(e=>a(C(k.player,e),t))?m.style.cursor="pointer":m.style.cursor="default")},oe=e=>{if("move"===k.getState()){const e={row:k.mouseGridRow,col:k.mouseGridCol};k.validCoord(e)&&o.some(t=>{const o=C(k.player,t);return!!a(o,e)&&(O(t),!0)})}},se={r:()=>k.newGame(),h:()=>{e=!e},g:()=>k.addResource("gems",5),k:()=>k.addResource("keys",5)},re={w:()=>O("NORTH"),ArrowUp:()=>O("NORTH"),e:()=>O("NORTH_EAST"),d:()=>O("SOUTH_EAST"),s:()=>O("SOUTH"),ArrowDown:()=>O("SOUTH"),a:()=>O("SOUTH_WEST"),q:()=>O("NORTH_WEST")},ie={d:()=>k.draft.index=T(k.draft.index+1,0,k.draft.options.length-1),ArrowRight:()=>k.draft.index=T(k.draft.index+1,0,k.draft.options.length-1),a:()=>k.draft.index=T(k.draft.index-1,0,k.draft.options.length-1),ArrowLeft:()=>k.draft.index=T(k.draft.index-1,0,k.draft.options.length-1)," ":()=>H(),Enter:()=>H(),r:()=>{k.getResource("gems")>=2&&(k.removeResource("gems",2),b())}},ne=e=>{const t=e.key,o=k.getState();se[t]?se[t]():"move"===o&&re[t]?re[t]():"draft"===o&&ie[t]&&ie[t]()};let ae=performance.now();const le=e=>{const t=1e3/(e-ae);ae=e,k.lastTimeStamp=e,(e=>{for(const t of g)t.active&&t.update(e);g=g.filter(e=>e.active)})(e),Z()?(p.textAlign="left",p.textBaseline="middle",p.fillStyle=F.Pink,p.font=`${G("sm")}px monospace`,p.fillText(`FPS: ${Math.round(t)}`,50,50)):(p.textAlign="center",p.textBaseline="middle",p.fillStyle=F.Red,p.font=`${G("sm")}px monospace`,p.fillText("Play area not suitable for this game, buy a proper display.",m.width/2,m.height/2)),requestAnimationFrame(le)};(async()=>{document.addEventListener("keydown",ne),document.addEventListener("mousemove",te),document.addEventListener("mouseup",oe),le(0)})().then(()=>console.log("Game started."));